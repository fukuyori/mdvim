<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mdvim v0.8.4 - VimÈ¢®„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„Ç®„Éá„Ç£„Çø</title>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7aa2f7">
  <meta name="description" content="Vim keybindings markdown editor with live preview">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- Turndown (HTML to Markdown) -->
  <script src="https://cdn.jsdelivr.net/npm/turndown@7.1.3/dist/turndown.min.js"></script>
  <!-- Mammoth (DOCX to HTML) -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <!-- KaTeX CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <!-- Highlight.js CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">
  <style>
/* „ÉÜ„Éº„ÉûÂÆöÁæ© */
:root, [data-theme="dark"] {
  --bg-primary: #1e1e2e;
  --bg-secondary: #313244;
  --bg-tertiary: #45475a;
  --text-primary: #cdd6f4;
  --text-secondary: #a6adc8;
  --accent: #89b4fa;
  --accent-green: #a6e3a1;
  --accent-yellow: #f9e2af;
  --accent-red: #f38ba8;
  --accent-purple: #cba6f7;
  --border: #585b70;
  /* Ë¶ãÂá∫„Åó„É¨„Éô„É´Âà•„ÅÆËâ≤ */
  --heading-h1: #f38ba8;
  --heading-h2: #fab387;
  --heading-h3: #f9e2af;
  --heading-h4: #a6e3a1;
  --heading-h5: #89b4fa;
  --heading-h6: #cba6f7;
}

[data-theme="light"] {
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f5;
  --bg-tertiary: #e0e0e0;
  --text-primary: #1a1a1a;
  --text-secondary: #555555;
  --accent: #0066cc;
  --accent-green: #2e7d32;
  --accent-yellow: #f9a825;
  --accent-red: #c62828;
  --accent-purple: #7b1fa2;
  --border: #cccccc;
  /* Ë¶ãÂá∫„Åó„É¨„Éô„É´Âà•„ÅÆËâ≤ */
  --heading-h1: #c62828;
  --heading-h2: #e65100;
  --heading-h3: #f9a825;
  --heading-h4: #2e7d32;
  --heading-h5: #0066cc;
  --heading-h6: #7b1fa2;
}

[data-theme="original"] {
  --bg-primary: #000000;
  --bg-secondary: #1a1a1a;
  --bg-tertiary: #2d2d2d;
  --text-primary: #00ff00;
  --text-secondary: #00cc00;
  --accent: #00ffff;
  --accent-green: #00ff00;
  --accent-yellow: #ffff00;
  --accent-red: #ff0000;
  --accent-purple: #ff00ff;
  --border: #333333;
  /* Ë¶ãÂá∫„Åó„É¨„Éô„É´Âà•„ÅÆËâ≤ */
  --heading-h1: #ff0000;
  --heading-h2: #ff8800;
  --heading-h3: #ffff00;
  --heading-h4: #00ff00;
  --heading-h5: #00ffff;
  --heading-h6: #ff00ff;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'JetBrains Mono', 'Fira Code', 'Source Code Pro', Consolas, monospace;
  background: var(--bg-primary);
  color: var(--text-primary);
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

body.drag-over {
  outline: 3px dashed var(--accent);
  outline-offset: -3px;
}

body.drag-over::after {
  content: '„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó„Åó„Å¶Èñã„Åè';
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--bg-secondary);
  color: var(--accent);
  padding: 2rem 3rem;
  border-radius: 12px;
  font-size: 1.2rem;
  z-index: 9999;
  pointer-events: none;
  border: 2px solid var(--accent);
}

.toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem 1rem;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
}

.logo { font-weight: bold; font-size: 1.1rem; color: var(--accent); }

.view-controls button {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  padding: 0.4rem 1rem;
  margin: 0 0.2rem;
  cursor: pointer;
  border-radius: 4px;
  font-family: inherit;
  font-size: 0.85rem;
  transition: all 0.2s;
}

.view-controls button:hover { background: var(--border); }
.view-controls button.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); }
.view-controls button[id^="btn-theme-"] { padding: 0.4rem 0.6rem; font-size: 1rem; }

#font-size-display {
  color: var(--text-secondary);
  font-size: 0.85rem;
  min-width: 3rem;
  text-align: center;
}

#language-selector {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  padding: 0.3rem 0.5rem;
  border-radius: 4px;
  font-family: inherit;
  font-size: 0.8rem;
  cursor: pointer;
  outline: none;
}

#language-selector:hover {
  background: var(--border);
}

#language-selector:focus {
  border-color: var(--accent);
}

.mode-indicator { display: flex; gap: 1rem; font-size: 0.9rem; align-items: center; }
#vim-mode { color: var(--accent-green); padding: 0.2rem 0.4rem; font-weight: bold; min-width: 60px; text-align: center; font-size: 0.85rem; }
#vim-mode.insert { color: var(--accent); }
#vim-mode.visual { color: var(--accent-yellow); }
#vim-mode.command { color: var(--accent-red); }
#vim-mode.recording { color: var(--accent-purple); }
#vim-mode.edit-mode { color: var(--text-secondary); }
#btn-vim-mode { min-width: 50px; }
#btn-vim-mode.active { background: var(--accent-green); color: var(--bg-primary); }
#cursor-pos { color: var(--text-secondary); }
#macro-indicator { color: var(--accent-purple); font-weight: bold; display: none; }
#macro-indicator.active { display: inline; }

#main-container { flex: 1 1 0; display: flex; overflow: hidden; }
.pane { flex: 1 1 0; display: flex; overflow: hidden; position: relative; }
#editor-pane { border-right: 1px solid var(--border); flex-direction: column; }
#editor-content { display: flex; flex: 1 1 0; overflow: hidden; }

#line-numbers {
  min-width: 3rem;
  background: var(--bg-secondary);
  color: var(--text-secondary);
  text-align: right;
  padding: 0.5rem 0.5rem 0.5rem 0;
  font-size: 0.95rem;
  line-height: 1.5;
  overflow: hidden;
  user-select: none;
  white-space: pre;
}

#line-numbers .line-num {
  display: block;
}

/* „ÉØ„Éº„Éâ„É©„ÉÉ„ÉóÊôÇ„ÅÆË°åÁï™Âè∑ */
#line-numbers.wrap-mode .line-num {
  display: flex;
  align-items: flex-start;
  justify-content: flex-end;
  box-sizing: border-box;
}

#line-numbers .heading-h1 { color: var(--heading-h1); }
#line-numbers .heading-h2 { color: var(--heading-h2); }
#line-numbers .heading-h3 { color: var(--heading-h3); }
#line-numbers .heading-h4 { color: var(--heading-h4); }
#line-numbers .heading-h5 { color: var(--heading-h5); }
#line-numbers .heading-h6 { color: var(--heading-h6); }

#editor-wrapper {
  flex: 1;
  position: relative;
  overflow: hidden;
}

#editor {
  width: 100%;
  height: 100%;
  background: var(--bg-primary);
  color: var(--text-primary);
  border: none;
  padding: 0.5rem;
  font-family: inherit;
  font-size: 0.95rem;
  line-height: 1.5;
  resize: none;
  outline: none;
  overflow: auto;
  white-space: pre;
  tab-size: 4;
  caret-color: transparent;
}

#editor.insert-mode {
  caret-color: var(--accent);
}

#cursor-overlay {
  position: absolute;
  pointer-events: none;
  background: var(--accent-green);
  opacity: 0.8;
  z-index: 10;
}

#cursor-overlay.insert {
  width: 2px !important;
  background: var(--accent);
  opacity: 1;
}

#cursor-overlay.visual {
  background: var(--accent-yellow);
}

#cursor-overlay.command {
  display: none;
}

@keyframes blink {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 0.3; }
}

#cursor-overlay.blink {
  animation: blink 1s ease-in-out infinite;
}

#preview-pane { 
  background: var(--bg-primary); 
  position: relative;
  overflow: hidden;
}

#preview-content { 
  position: absolute;
  top: 42px;
  left: 0;
  right: 0;
  bottom: 0;
  overflow: auto;
  padding: 1.5rem;
}

#preview-content h1 { font-size: 2rem; margin: 1rem 0 0.5rem; color: var(--heading-h1); border-bottom: 2px solid var(--border); padding-bottom: 0.3rem; }
#preview-content h2 { font-size: 1.6rem; margin: 1rem 0 0.5rem; color: var(--heading-h2); }
#preview-content h3 { font-size: 1.3rem; margin: 0.8rem 0 0.4rem; color: var(--heading-h3); }
#preview-content h4 { margin: 0.6rem 0 0.3rem; color: var(--heading-h4); }
#preview-content h5 { margin: 0.6rem 0 0.3rem; color: var(--heading-h5); }
#preview-content h6 { margin: 0.6rem 0 0.3rem; color: var(--heading-h6); }
#preview-content p { margin: 0.6rem 0; line-height: 1.7; }
#preview-content ul, #preview-content ol { margin: 0.5rem 0; padding-left: 1.5rem; }
#preview-content li { margin: 0.3rem 0; }
#preview-content code { background: var(--bg-secondary); padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.9em; }
#preview-content pre { background: var(--bg-secondary); padding: 1rem; border-radius: 6px; overflow-x: auto; margin: 0.8rem 0; line-height: 1.4; }
#preview-content pre code { background: none; padding: 0; line-height: 1.4; display: block; }

/* MermaidÂõ≥„ÅÆ„Çπ„Çø„Ç§„É´ */
#preview-content .mermaid {
  background: var(--bg-secondary);
  padding: 1rem;
  border-radius: 6px;
  margin: 0.8rem 0;
  text-align: center;
  overflow-x: auto;
}

#preview-content .mermaid svg {
  max-width: 100%;
  height: auto;
}

/* Êäò„ÇäÁï≥„ÅøÔºàdetailsÔºâ„ÅÆ„Çπ„Çø„Ç§„É´ */
#preview-content details.collapsible {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 6px;
  margin: 0.8rem 0;
  overflow: hidden;
}

#preview-content details.collapsible summary {
  background: var(--bg-tertiary);
  padding: 0.6rem 1rem;
  cursor: pointer;
  font-weight: bold;
  user-select: none;
  list-style: none;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

#preview-content details.collapsible summary::-webkit-details-marker {
  display: none;
}

#preview-content details.collapsible summary::before {
  content: "‚ñ∂";
  font-size: 0.8em;
  transition: transform 0.2s;
}

#preview-content details.collapsible[open] summary::before {
  transform: rotate(90deg);
}

#preview-content details.collapsible summary:hover {
  background: var(--border);
}

#preview-content details.collapsible .details-content {
  padding: 1rem;
  border-top: 1px solid var(--border);
}

#preview-content details.collapsible .details-content > :first-child {
  margin-top: 0;
}

#preview-content details.collapsible .details-content > :last-child {
  margin-bottom: 0;
}

/* „Éó„É¨„Éì„É•„ÉºË¶ãÂá∫„ÅóÊäò„ÇäÁï≥„Åø„Çπ„Çø„Ç§„É´ */
#preview-content h1,
#preview-content h2,
#preview-content h3,
#preview-content h4,
#preview-content h5,
#preview-content h6 {
  position: relative;
  transition: opacity 0.2s;
}

#preview-content .fold-indicator {
  font-size: 0.7em;
  margin-right: 0.5rem;
  opacity: 0.5;
  transition: transform 0.2s, opacity 0.2s;
  display: inline-block;
}

#preview-content h1:hover .fold-indicator,
#preview-content h2:hover .fold-indicator,
#preview-content h3:hover .fold-indicator,
#preview-content h4:hover .fold-indicator,
#preview-content h5:hover .fold-indicator,
#preview-content h6:hover .fold-indicator {
  opacity: 1;
}

#preview-content .folded .fold-indicator {
  transform: rotate(-90deg);
}

#preview-content .heading-hidden {
  display: none !important;
}

/* „Éó„É¨„Éì„É•„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„Éê„Éº */
#preview-controls {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  gap: 0.5rem;
  padding: 0.5rem;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  z-index: 1;
}

#preview-controls button {
  padding: 0.3rem 0.8rem;
  font-size: 0.8rem;
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

#preview-controls button:hover {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
}

/* „Ç®„Éá„Ç£„Çø„Ç≥„É≥„Éà„É≠„Éº„É´„Éê„Éº */
#editor-controls {
  display: flex;
  gap: 0.5rem;
  padding: 0.5rem;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  align-items: center;
}

#editor-controls button {
  padding: 0.3rem 0.8rem;
  font-size: 0.8rem;
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

#editor-controls button:hover {
  background: var(--accent);
  color: var(--bg-primary);
  border-color: var(--accent);
}

#editor-controls button.active {
  background: var(--accent-green);
  color: var(--bg-primary);
  border-color: var(--accent-green);
}

#editor-controls #vim-mode {
  /* „É¢„Éº„ÉâË°®Á§∫ */
}

#editor-controls #cursor-pos {
  color: var(--text-secondary);
  font-size: 0.85rem;
  margin-right: auto;
}

#editor-controls #macro-indicator {
  color: var(--accent-red);
  font-weight: bold;
  font-size: 0.8rem;
  display: none;
}

#editor-controls #macro-indicator.active {
  display: inline;
  animation: blink 1s infinite;
}

/* ÁõÆÊ¨°„Éë„Éç„É´ */
#toc-pane {
  width: 200px;
  min-width: 150px;
  max-width: 300px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: width 0.2s, min-width 0.2s;
}

#toc-pane.collapsed {
  width: 0;
  min-width: 0;
  border-right: none;
}

#toc-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem;
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border);
  font-weight: bold;
  font-size: 0.85rem;
  color: var(--text-primary);
}

#toc-header button {
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 0.2rem 0.4rem;
  font-size: 0.8rem;
}

#toc-header button:hover {
  color: var(--accent);
}

#toc-content {
  flex: 1;
  overflow-y: auto;
  padding: 0.5rem 0;
}

/* ÁõÆÊ¨°„Ç®„É≥„Éà„É™ */
.toc-entry {
  padding: 0.4rem 0.8rem;
  cursor: pointer;
  font-size: 0.9rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  transition: background 0.15s;
}

.toc-entry:hover {
  background: var(--bg-tertiary);
}

/* Ë¶ãÂá∫„Åó„É¨„Éô„É´Âà•„ÅÆËâ≤Ôºà„Éó„É¨„Éì„É•„Éº„Å®Âêå„ÅòÔºâ */
.toc-entry.toc-h1 { color: var(--heading-h1); font-weight: bold; }
.toc-entry.toc-h2 { color: var(--heading-h2); font-weight: 600; }
.toc-entry.toc-h3 { color: var(--heading-h3); }
.toc-entry.toc-h4 { color: var(--heading-h4); font-size: 0.85rem; }
.toc-entry.toc-h5 { color: var(--heading-h5); font-size: 0.85rem; }
.toc-entry.toc-h6 { color: var(--heading-h6); font-size: 0.85rem; }

.toc-item {
  padding: 0.4rem 0.8rem;
  cursor: pointer;
  font-size: 0.9rem;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  border-left: 3px solid transparent;
  transition: all 0.15s;
  text-decoration: none;
  display: block;
}

.toc-item:hover {
  background: var(--bg-tertiary);
}

.toc-item.active {
  background: var(--bg-tertiary);
  border-left-color: var(--accent);
}

/* Ë¶ãÂá∫„Åó„É¨„Éô„É´Âà•Ôºö„Ç§„É≥„Éá„É≥„Éà„ÅÆ„Åø„ÄÅËâ≤„ÅØtext-primary„ÅßÁµ±‰∏Ä */
.toc-item.h1 { padding-left: 0.8rem; font-weight: bold; font-size: 0.95rem; }
.toc-item.h2 { padding-left: 1.3rem; font-weight: 600; }
.toc-item.h3 { padding-left: 1.8rem; }
.toc-item.h4 { padding-left: 2.3rem; font-size: 0.85rem; }
.toc-item.h5 { padding-left: 2.8rem; font-size: 0.85rem; }
.toc-item.h6 { padding-left: 3.3rem; font-size: 0.85rem; }

#toc-open-btn {
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-left: none;
  border-radius: 0 4px 4px 0;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 0.5rem 0.3rem;
  font-size: 0.8rem;
  z-index: 10;
}

#toc-open-btn:hover {
  background: var(--bg-tertiary);
  color: var(--accent);
}

#toc-open-btn.hidden {
  display: none;
}
#preview-content blockquote { border-left: 4px solid var(--accent); padding-left: 1rem; margin: 0.8rem 0; color: var(--text-secondary); font-style: italic; }
#preview-content hr { border: none; border-top: 1px solid var(--border); margin: 1.5rem 0; }
#preview-content a { color: var(--accent); text-decoration: none; }
#preview-content a:hover { text-decoration: underline; }
#preview-content img { max-width: 100%; border-radius: 6px; }
#preview-content table { border-collapse: collapse; margin: 0.8rem 0; width: 100%; }
#preview-content th, #preview-content td { border: 1px solid var(--border); padding: 0.5rem; text-align: left; }
#preview-content th { background: var(--bg-secondary); }

/* KaTeXÊï∞Âºè„Çπ„Çø„Ç§„É´ */
#preview-content .katex-display {
  margin: 1rem 0;
  overflow-x: auto;
  overflow-y: hidden;
}

#preview-content .katex {
  font-size: 1.1em;
}

#preview-content .math-inline {
  display: inline;
}

#preview-content .math-block {
  display: block;
  text-align: center;
  margin: 1rem 0;
}

#preview-content .math-error {
  color: var(--accent-red);
  font-family: monospace;
  font-size: 0.9em;
}

.edit-only #preview-pane { display: none; }
.edit-only #editor-pane { border-right: none; }
.preview-only #editor-pane { display: none; }

#command-line {
  display: flex;
  align-items: center;
  padding: 0.3rem 0.5rem;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
}

#command-line.hidden { display: none; }
#command-prefix { color: var(--accent); font-weight: bold; margin-right: 0.3rem; }
#command-input { flex: 1; background: transparent; border: none; color: var(--text-primary); font-family: inherit; font-size: 0.95rem; outline: none; }

#status-bar {
  display: flex;
  justify-content: space-between;
  padding: 0.3rem 1rem;
  background: var(--bg-tertiary);
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal.hidden { display: none; }

.modal-content {
  background: var(--bg-secondary);
  padding: 1.5rem;
  border-radius: 8px;
  max-width: 1000px;
  max-height: 85vh;
  overflow: auto;
}

.modal-content h2 { color: var(--accent); margin-bottom: 1rem; text-align: center; }
.help-columns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
.help-section h3 { color: var(--accent-yellow); margin-bottom: 0.5rem; font-size: 1rem; }
.help-section ul { list-style: none; }
.help-section li { margin: 0.3rem 0; font-size: 0.85rem; }
kbd { background: var(--bg-tertiary); padding: 0.1rem 0.4rem; border-radius: 3px; border: 1px solid var(--border); font-family: inherit; font-size: 0.85em; }
.modal-content > button { display: block; margin: 1.5rem auto 0; padding: 0.5rem 2rem; background: var(--accent); color: var(--bg-primary); border: none; border-radius: 4px; font-family: inherit; cursor: pointer; font-size: 1rem; }
.new-feature { color: var(--accent-green); font-size: 0.75em; margin-left: 0.3rem; }

@media (max-width: 900px) {
  .help-columns { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 600px) {
  .help-columns { grid-template-columns: 1fr; }
  .toolbar { flex-wrap: wrap; gap: 0.5rem; }
}

/* „Çø„Çπ„ÇØ„É™„Çπ„Éà */
.task-list {
  list-style: none;
  padding-left: 0;
}

.task-item {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
}

.task-item input[type="checkbox"] {
  margin-top: 0.3rem;
  accent-color: var(--accent);
}

/* GitHub Alerts */
.alert {
  padding: 1rem;
  margin: 1rem 0;
  border-radius: 6px;
  border-left: 4px solid;
}

.alert-title {
  display: block;
  font-weight: bold;
  margin-bottom: 0.5rem;
}

.alert p {
  margin: 0;
}

.alert-note {
  background: rgba(56, 139, 253, 0.1);
  border-color: #388bfd;
}

.alert-note .alert-title {
  color: #388bfd;
}

.alert-tip {
  background: rgba(46, 160, 67, 0.1);
  border-color: #2ea043;
}

.alert-tip .alert-title {
  color: #2ea043;
}

.alert-important {
  background: rgba(130, 80, 223, 0.1);
  border-color: #8250df;
}

.alert-important .alert-title {
  color: #8250df;
}

.alert-warning {
  background: rgba(210, 153, 34, 0.1);
  border-color: #d29922;
}

.alert-warning .alert-title {
  color: #d29922;
}

.alert-caution {
  background: rgba(248, 81, 73, 0.1);
  border-color: #f85149;
}

.alert-caution .alert-title {
  color: #f85149;
}

/* Highlight.js „ÅÆ„Çπ„Çø„Ç§„É´Ë™øÊï¥ */
#preview-content pre code.hljs {
  background: transparent;
  padding: 0;
}

/* Qiita noteË®òÊ≥ï */
.note {
  display: flex;
  padding: 1rem;
  margin: 1rem 0;
  border-radius: 6px;
  gap: 0.75rem;
}

.note-icon {
  font-size: 1.2rem;
  flex-shrink: 0;
}

.note-content {
  flex: 1;
}

.note-content p:first-child {
  margin-top: 0;
  font-weight: bold;
}

.note-content p:last-child {
  margin-bottom: 0;
}

.note-info {
  background: #e6f6e6;
  border-left: 4px solid #55c500;
}

.note-warn {
  background: #fff9e6;
  border-left: 4px solid #ffc800;
}

.note-alert {
  background: #ffe6e6;
  border-left: 4px solid #dd0000;
}

/* „ÉÄ„Éº„ÇØ„ÉÜ„Éº„ÉûÁî® */
[data-theme="dark"] .note-info {
  background: rgba(85, 197, 0, 0.15);
}

[data-theme="dark"] .note-warn {
  background: rgba(255, 200, 0, 0.15);
}

[data-theme="dark"] .note-alert {
  background: rgba(221, 0, 0, 0.15);
}
</style>
</head>
<body>
  <header class="toolbar">
    <div class="logo">üìù mdvim <span style="font-size: 0.8em; color: var(--accent-green);">v0.8.4</span></div>
    <div class="view-controls">
      <button id="btn-edit" onclick="setViewMode('edit')">Edit</button>
      <button id="btn-preview" onclick="setViewMode('preview')">Preview</button>
      <button id="btn-split" class="active" onclick="setViewMode('split')">Split</button>
      <span style="margin: 0 0.5rem; color: var(--border);">|</span>
      <button id="btn-theme-dark" class="active" onclick="setTheme('dark')">üåô</button>
      <button id="btn-theme-light" onclick="setTheme('light')">‚òÄÔ∏è</button>
      <button id="btn-theme-original" onclick="setTheme('original')">üíª</button>
      <span style="margin: 0 0.5rem; color: var(--border);">|</span>
      <button onclick="vimEditor.decreaseFontSize()" title="Smaller font">A-</button>
      <span id="font-size-display">100%</span>
      <button onclick="vimEditor.increaseFontSize()" title="Larger font">A+</button>
      <span style="margin: 0 0.5rem; color: var(--border);">|</span>
      <select id="language-selector" onchange="vimEditor.setLanguage(this.value)">
        <option value="en" selected>English</option>
        <option value="ja">Êó•Êú¨Ë™û</option>
        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
        <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
        <option value="es">Espa√±ol</option>
      </select>
    </div>
  </header>
  
  <main id="main-container" class="split-view">
    <div id="toc-pane">
      <div id="toc-header">
        <span>Table of Contents</span>
        <button id="toc-toggle" onclick="vimEditor.toggleToc()" title="Close TOC">‚óÄ</button>
      </div>
      <div id="toc-content"></div>
    </div>
    <button id="toc-open-btn" class="hidden" onclick="vimEditor.toggleToc()" title="Open TOC">‚ñ∂</button>
    <div id="editor-pane" class="pane">
      <div id="editor-controls">
        <span id="vim-mode">NORMAL</span>
        <span id="cursor-pos">1:1</span>
        <span id="macro-indicator">‚óèREC</span>
        <button id="btn-vim-mode" onclick="vimEditor.toggleVimMode()" title="VIM/Edit mode toggle">NOVIM</button>
      </div>
      <div id="editor-content">
        <div id="line-numbers"></div>
        <div id="editor-wrapper">
          <textarea id="editor" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
          <div id="cursor-overlay"></div>
        </div>
      </div>
    </div>
    <div id="preview-pane" class="pane">
      <div id="preview-controls">
        <button onclick="vimEditor.foldAllHeadings()" title="Fold All">‚ñ∂ Fold All</button>
        <button onclick="vimEditor.unfoldAllHeadings()" title="Unfold All">‚ñº Unfold All</button>
      </div>
      <div id="preview-content"></div>
    </div>
  </main>
  
  <div id="command-line" class="hidden">
    <span id="command-prefix">:</span>
    <input type="text" id="command-input">
  </div>
  
  <input type="file" id="file-input" accept=".md,.txt,.markdown,.mdvim" style="display: none;">
  
  <footer id="status-bar">
    <span id="file-name">Untitled</span>
    <span id="file-status"></span>
    <span id="help-hint">:help to show help</span>
  </footer>
  
  <div id="help-modal" class="modal hidden">
    <div class="modal-content">
      <h2>‚å®Ô∏è Keybinding Help</h2>
      <div class="help-columns">
        <div class="help-section">
          <h3>Mode Switch</h3>
          <ul>
            <li><kbd>i</kbd> Insert (at cursor)</li>
            <li><kbd>I</kbd> Insert (line start)</li>
            <li><kbd>a</kbd> Insert (after cursor)</li>
            <li><kbd>A</kbd> Insert (line end)</li>
            <li><kbd>o</kbd> Insert line below</li>
            <li><kbd>O</kbd> Insert line above</li>
            <li><kbd>v</kbd> Visual mode</li>
            <li><kbd>V</kbd> Visual line mode</li>
            <li><kbd>Esc</kbd> / <kbd>Ctrl+[</kbd> To normal</li>
            <li><kbd>:</kbd> Command mode</li>
          </ul>
        </div>
        <div class="help-section">
          <h3>Movement</h3>
          <ul>
            <li><kbd>h</kbd>/<kbd>j</kbd>/<kbd>k</kbd>/<kbd>l</kbd> Left/Down/Up/Right</li>
            <li><kbd>w</kbd>/<kbd>b</kbd> Word (next/prev)</li>
            <li><kbd>e</kbd> Word end</li>
            <li><kbd>0</kbd>/<kbd>$</kbd> Line start/end</li>
            <li><kbd>^</kbd> First non-blank</li>
            <li><kbd>gg</kbd>/<kbd>G</kbd> File start/end</li>
            <li><kbd>f</kbd><i>x</i> / <kbd>F</kbd><i>x</i> Find <i>x</i> in line</li>
            <li><kbd>%</kbd> Matching bracket</li>
            <li><kbd>Ctrl+f</kbd>/<kbd>Ctrl+b</kbd> Page movement</li>
            <li><kbd>Ctrl+d</kbd>/<kbd>Ctrl+u</kbd> Half page</li>
          </ul>
        </div>
        <div class="help-section">
          <h3>Editing</h3>
          <ul>
            <li><kbd>x</kbd> / <kbd>X</kbd> Delete char</li>
            <li><kbd>dd</kbd> / <kbd>dw</kbd> / <kbd>D</kbd> Delete</li>
            <li><kbd>cc</kbd> / <kbd>cw</kbd> / <kbd>C</kbd> Change</li>
            <li><kbd>yy</kbd> / <kbd>yw</kbd> / <kbd>Y</kbd> Yank</li>
            <li><kbd>p</kbd> / <kbd>P</kbd> Paste</li>
            <li><kbd>u</kbd> / <kbd>Ctrl+r</kbd> Undo/Redo</li>
            <li><kbd>.</kbd> Repeat last edit</li>
            <li><kbd>~</kbd> Toggle case</li>
            <li><kbd>J</kbd> Join lines</li>
            <li><kbd>>></kbd> / <kbd><<</kbd> Indent</li>
          </ul>
        </div>
        <div class="help-section">
          <h3>Text Objects</h3>
          <ul>
            <li><kbd>diw</kbd> / <kbd>daw</kbd> Delete word</li>
            <li><kbd>di"</kbd> / <kbd>da"</kbd> Delete in "..."</li>
            <li><kbd>di(</kbd> / <kbd>da(</kbd> Delete in (...)</li>
            <li><kbd>di[</kbd> / <kbd>da[</kbd> Delete in [...]</li>
            <li><kbd>di{</kbd> / <kbd>da{</kbd> Delete in {...}</li>
          </ul>
          <h3 style="margin-top: 1rem;">Marks & Macros</h3>
          <ul>
            <li><kbd>m</kbd><i>a-z</i> Set mark</li>
            <li><kbd>'</kbd><i>a-z</i> Go to mark</li>
            <li><kbd>q</kbd><i>a-z</i> Record macro</li>
            <li><kbd>@</kbd><i>a-z</i> Play macro</li>
          </ul>
        </div>
        <div class="help-section">
          <h3>Search & Replace</h3>
          <ul>
            <li><kbd>/</kbd><i>pattern</i> Forward search</li>
            <li><kbd>n</kbd> / <kbd>N</kbd> Next/Prev match</li>
            <li><kbd>*</kbd> Search word under cursor</li>
            <li><kbd>:s/old/new/</kbd> Replace (line)</li>
            <li><kbd>:%s/old/new/g</kbd> Replace all</li>
          </ul>
          <h3 style="margin-top: 1rem;">Commands</h3>
          <ul>
            <li><kbd>:w</kbd> Save</li>
            <li><kbd>:e</kbd> Open file</li>
            <li><kbd>:new</kbd> New file</li>
            <li><kbd>:q</kbd> Quit</li>
            <li><kbd>:help</kbd> Show help</li>
          </ul>
        </div>
        <div class="help-section">
          <h3>Markdown</h3>
          <ul>
            <li><kbd>$...$</kbd> Inline math</li>
            <li><kbd>$$...$$</kbd> Block math</li>
            <li><kbd>```mermaid</kbd> Mermaid diagram</li>
            <li><kbd>:::details</kbd> Collapsible</li>
          </ul>
        </div>
      </div>
      <button onclick="toggleHelp()">Close (Esc)</button>
    </div>
  </div>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false, theme: 'dark' });</script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>

  <script>
"use strict";var mdvim=(()=>{var He=Object.defineProperty;var xt=Object.getOwnPropertyDescriptor;var Ct=Object.getOwnPropertyNames;var It=Object.prototype.hasOwnProperty;var Ft=(s,e)=>{for(var t in e)He(s,t,{get:e[t],enumerable:!0})},Pt=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Ct(e))!It.call(s,i)&&i!==t&&He(s,i,{get:()=>e[i],enumerable:!(n=xt(e,i))||n.enumerable});return s};var At=s=>Pt(He({},"__esModule",{value:!0}),s);var Bt={};Ft(Bt,{CommandHistory:()=>le,MarkdownParser:()=>J,SessionManager:()=>X,VERSION:()=>$t,VimEditor:()=>te,addClass:()=>ot,countChars:()=>Qe,countLines:()=>Ze,countWords:()=>Ye,createElement:()=>st,debounce:()=>mt,dedentLine:()=>V,default:()=>te,deleteLine:()=>U,deleteRange:()=>K,deleteToLineEnd:()=>j,deleteWord:()=>Z,dispatchCustomEvent:()=>ht,downloadBlob:()=>gt,downloadFile:()=>De,escapeHtml:()=>$,escapeRegex:()=>qe,executeCommand:()=>Ke,findCharInLine:()=>Y,getCommand:()=>Lt,getCompletions:()=>Ot,getCurrentColumn:()=>Mt,getCurrentLine:()=>wt,getCursorInfo:()=>We,getElementById:()=>L,getElementByIdOrNull:()=>et,getExtension:()=>ft,getFromRegister:()=>_,getLineFromPosition:()=>ue,getLineText:()=>Ge,getPositionFromLine:()=>Xe,getSelection:()=>dt,hasClass:()=>at,indentLine:()=>ee,isFileSystemAccessSupported:()=>q,isTextFile:()=>ge,isWhitespace:()=>H,isWordChar:()=>N,joinLines:()=>re,markdownParser:()=>B,moveDown:()=>se,moveLeft:()=>G,moveRight:()=>z,moveToDocumentEnd:()=>Le,moveToDocumentStart:()=>Me,moveToFirstNonBlank:()=>D,moveToLine:()=>Te,moveToLineEnd:()=>W,moveToLineStart:()=>Q,moveToMatchingBracket:()=>Be,moveUp:()=>ie,moveWordBackward:()=>we,moveWordEnd:()=>Oe,moveWordEndBackward:()=>$e,moveWordForward:()=>ye,normalizeCRLF:()=>M,openFile:()=>fe,openFileWithInput:()=>ut,parseInline:()=>E,parseMarkdown:()=>R,pasteAfter:()=>ke,pasteBefore:()=>Ee,querySelector:()=>tt,querySelectorAll:()=>it,querySelectorOrNull:()=>nt,readDroppedFile:()=>Se,redo:()=>Ie,registerBuiltinCommands:()=>ze,registerCommand:()=>C,removeClass:()=>rt,removeExtension:()=>vt,sanitizeFilename:()=>St,saveFile:()=>ve,saveToHistory:()=>xe,saveToRegister:()=>k,scrollIntoView:()=>ct,sessionManager:()=>F,setSelection:()=>S,setVisible:()=>lt,slugify:()=>Je,splitLines:()=>I,throttle:()=>pt,toggleCase:()=>ae,toggleClass:()=>Re,undo:()=>Ce,yankLine:()=>oe});function M(s){return s?s.replace(/\r\n/g,`
`).replace(/\r/g,`
`):""}function $(s){let e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return s.replace(/[&<>"']/g,t=>e[t])}function qe(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Je(s){return s.toLowerCase().trim().replace(/[\s]+/g,"-").replace(/[^\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF-]/g,"").replace(/--+/g,"-").replace(/^-+|-+$/g,"")}function I(s){return s.split(`
`)}function Xe(s,e){let t=I(s),n=0;for(let i=0;i<e&&i<t.length;i++)n+=t[i].length+1;return n}function ue(s,e){return(s.substring(0,e).match(/\n/g)||[]).length}function Ge(s,e){return I(s)[e]||""}function N(s){return/[\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(s)}function H(s){return/\s/.test(s)}function Qe(s){return[...s].length}function Ye(s){let e=s.trim();if(!e)return 0;let t=e.match(/[a-zA-Z]+/g)||[],n=e.match(/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g)||[];return t.length+n.length}function Ze(s){return s?I(s).length:0}function L(s){let e=document.getElementById(s);if(!e)throw new Error(`Element not found: #${s}`);return e}function et(s){return document.getElementById(s)}function tt(s,e=document){let t=e.querySelector(s);if(!t)throw new Error(`Element not found: ${s}`);return t}function nt(s,e=document){return e.querySelector(s)}function it(s,e=document){return Array.from(e.querySelectorAll(s))}function st(s,e,t){let n=document.createElement(s);if(e)for(let[i,o]of Object.entries(e))n.setAttribute(i,o);if(t)for(let i of t)typeof i=="string"?n.appendChild(document.createTextNode(i)):n.appendChild(i);return n}function Re(s,e,t){return s.classList.toggle(e,t)}function ot(s,...e){s.classList.add(...e)}function rt(s,...e){s.classList.remove(...e)}function at(s,e){return s.classList.contains(e)}function lt(s,e){Re(s,"hidden",!e)}function ct(s,e){s.scrollIntoView({behavior:"smooth",block:"center",...e})}function S(s,e,t){s.selectionStart=e,s.selectionEnd=t??e,s.focus()}function dt(s){return{start:s.selectionStart,end:s.selectionEnd,text:s.value.substring(s.selectionStart,s.selectionEnd)}}function ht(s,e,t){let n=new CustomEvent(e,{detail:t,bubbles:!0,cancelable:!0});return s.dispatchEvent(n)}function mt(s,e){let t=null;return function(...n){t&&clearTimeout(t),t=setTimeout(()=>{s.apply(this,n)},e)}}function pt(s,e){let t=!1;return function(...n){t||(s.apply(this,n),t=!0,setTimeout(()=>{t=!1},e))}}function q(){return"showOpenFilePicker"in window&&"showSaveFilePicker"in window}async function fe(){if(!q())return null;try{let[s]=await window.showOpenFilePicker({types:[{description:"Markdown files",accept:{"text/markdown":[".md",".markdown"],"text/plain":[".txt"]}}],multiple:!1}),e=await s.getFile(),t=await e.text();return{content:M(t),name:e.name,handle:s}}catch(s){if(s.name==="AbortError")return null;throw s}}function ut(s){return new Promise(e=>{let t=async()=>{let n=s.files?.[0];if(!n){e(null);return}let i=await n.text();e({content:M(i),name:n.name}),s.value=""};s.onchange=t,s.click()})}async function ve(s,e,t){if(!q())return De(s,e),null;try{let n=t||await window.showSaveFilePicker({suggestedName:e,types:[{description:"Markdown files",accept:{"text/markdown":[".md"]}},{description:"Text files",accept:{"text/plain":[".txt"]}}]}),i=await n.createWritable();return await i.write(s),await i.close(),n}catch(n){if(n.name==="AbortError")return null;throw n}}function De(s,e,t="text/plain"){let n=new Blob([s],{type:t}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=e,o.click(),URL.revokeObjectURL(i)}function gt(s,e){let t=URL.createObjectURL(s),n=document.createElement("a");n.href=t,n.download=e,n.click(),URL.revokeObjectURL(t)}async function Se(s){let e=s.items;if(e&&e.length>0&&"getAsFileSystemHandle"in e[0])try{let n=await e[0].getAsFileSystemHandle();if(n&&n.kind==="file"){let i=n,o=await i.getFile();if(ge(o)){let r=await o.text();return{content:M(r),name:o.name,handle:i}}}}catch{}let t=s.files[0];if(t&&ge(t)){let n=await t.text();return{content:M(n),name:t.name}}return null}function ge(s){return s.type.startsWith("text/")||s.name.endsWith(".md")||s.name.endsWith(".markdown")||s.name.endsWith(".txt")}function ft(s){let e=s.lastIndexOf(".");return e===-1?"":s.substring(e+1).toLowerCase()}function vt(s){let e=s.lastIndexOf(".");return e===-1?s:s.substring(0,e)}function St(s){return s.replace(/[<>:"/\\|?*]/g,"_").replace(/\s+/g,"_").substring(0,255)}var Nt={":smile:":"\u{1F604}",":laughing:":"\u{1F606}",":blush:":"\u{1F60A}",":smiley:":"\u{1F603}",":relaxed:":"\u263A\uFE0F",":smirk:":"\u{1F60F}",":heart_eyes:":"\u{1F60D}",":kissing_heart:":"\u{1F618}",":kissing:":"\u{1F617}",":flushed:":"\u{1F633}",":relieved:":"\u{1F60C}",":satisfied:":"\u{1F606}",":grin:":"\u{1F601}",":wink:":"\u{1F609}",":stuck_out_tongue_winking_eye:":"\u{1F61C}",":stuck_out_tongue:":"\u{1F61B}",":sleeping:":"\u{1F634}",":worried:":"\u{1F61F}",":frowning:":"\u{1F626}",":anguished:":"\u{1F627}",":open_mouth:":"\u{1F62E}",":grimacing:":"\u{1F62C}",":confused:":"\u{1F615}",":hushed:":"\u{1F62F}",":expressionless:":"\u{1F611}",":unamused:":"\u{1F612}",":sweat_smile:":"\u{1F605}",":sweat:":"\u{1F613}",":weary:":"\u{1F629}",":pensive:":"\u{1F614}",":disappointed:":"\u{1F61E}",":confounded:":"\u{1F616}",":fearful:":"\u{1F628}",":cold_sweat:":"\u{1F630}",":persevere:":"\u{1F623}",":cry:":"\u{1F622}",":sob:":"\u{1F62D}",":joy:":"\u{1F602}",":astonished:":"\u{1F632}",":scream:":"\u{1F631}",":tired_face:":"\u{1F62B}",":angry:":"\u{1F620}",":rage:":"\u{1F621}",":triumph:":"\u{1F624}",":sleepy:":"\u{1F62A}",":yum:":"\u{1F60B}",":mask:":"\u{1F637}",":sunglasses:":"\u{1F60E}",":dizzy_face:":"\u{1F635}",":imp:":"\u{1F47F}",":smiling_imp:":"\u{1F608}",":neutral_face:":"\u{1F610}",":no_mouth:":"\u{1F636}",":innocent:":"\u{1F607}",":alien:":"\u{1F47D}",":heart:":"\u2764\uFE0F",":broken_heart:":"\u{1F494}",":star:":"\u2B50",":star2:":"\u{1F31F}",":sparkles:":"\u2728",":zap:":"\u26A1",":fire:":"\u{1F525}",":boom:":"\u{1F4A5}",":+1:":"\u{1F44D}",":thumbsup:":"\u{1F44D}",":-1:":"\u{1F44E}",":thumbsdown:":"\u{1F44E}",":ok_hand:":"\u{1F44C}",":punch:":"\u{1F44A}",":fist:":"\u270A",":v:":"\u270C\uFE0F",":wave:":"\u{1F44B}",":hand:":"\u270B",":clap:":"\u{1F44F}",":pray:":"\u{1F64F}",":point_up:":"\u261D\uFE0F",":point_down:":"\u{1F447}",":point_left:":"\u{1F448}",":point_right:":"\u{1F449}",":rocket:":"\u{1F680}",":warning:":"\u26A0\uFE0F",":x:":"\u274C",":white_check_mark:":"\u2705",":heavy_check_mark:":"\u2714\uFE0F",":question:":"\u2753",":exclamation:":"\u2757",":bulb:":"\u{1F4A1}",":memo:":"\u{1F4DD}",":book:":"\u{1F4D6}",":bookmark:":"\u{1F516}",":link:":"\u{1F517}",":wrench:":"\u{1F527}",":hammer:":"\u{1F528}",":nut_and_bolt:":"\u{1F529}",":gear:":"\u2699\uFE0F",":package:":"\u{1F4E6}",":tada:":"\u{1F389}",":100:":"\u{1F4AF}",":bug:":"\u{1F41B}",":construction:":"\u{1F6A7}",":rotating_light:":"\u{1F6A8}",":lock:":"\u{1F512}",":unlock:":"\u{1F513}",":key:":"\u{1F511}",":mag:":"\u{1F50D}",":email:":"\u{1F4E7}",":phone:":"\u{1F4F1}",":computer:":"\u{1F4BB}",":desktop_computer:":"\u{1F5A5}\uFE0F",":folder:":"\u{1F4C1}",":file_folder:":"\u{1F4C2}",":clipboard:":"\u{1F4CB}",":calendar:":"\u{1F4C5}",":clock:":"\u{1F550}",":hourglass:":"\u231B",":sun:":"\u2600\uFE0F",":moon:":"\u{1F319}",":cloud:":"\u2601\uFE0F",":umbrella:":"\u2602\uFE0F",":snowflake:":"\u2744\uFE0F",":coffee:":"\u2615",":beer:":"\u{1F37A}",":pizza:":"\u{1F355}"};function be(s){return s.replace(/:([a-z0-9_+-]+):/g,e=>Nt[e]||e)}function E(s){let e=s;e=e.replace(/(?<!\$)\$(?!\$)([^$\n]+?)\$(?!\$)/g,(n,i)=>`<span class="math-inline" data-math="${$(i)}"></span>`),e=e.replace(/`([^`]+)`/g,"<code>$1</code>"),e=e.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,'<img src="$2" alt="$1">'),e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2">$1</a>');let t=[];return e=e.replace(/<[^>]+>/g,n=>(t.push(n),`\0PH${t.length-1}\0`)),e=e.replace(/~~([^~]+)~~/g,"<del>$1</del>"),e=e.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),e=e.replace(/__([^_]+)__/g,"<strong>$1</strong>"),e=e.replace(/\*([^*]+)\*/g,"<em>$1</em>"),e=e.replace(/_([^_]+)_/g,"<em>$1</em>"),e=e.replace(/\x00PH(\d+)\x00/g,(n,i)=>t[parseInt(i)]),e=e.replace(/(?<!href="|src="|<a[^>]*>)(https?:\/\/[^\s<>"']+)/g,'<a href="$1">$1</a>'),e=be(e),e}var bt={NOTE:"\u2139\uFE0F",TIP:"\u{1F4A1}",IMPORTANT:"\u2757",WARNING:"\u26A0\uFE0F",CAUTION:"\u{1F534}"},yt={info:"\u2705",warn:"\u26A0\uFE0F",alert:"\u{1F6AB}"};function Ht(s){if(s.length===0)return"";let e=(t,n,i)=>{let o="",r=n,a=t[r].type,l=t[r].isTask;for(a==="ol"?o+="<ol>":l?o+='<ul class="task-list">':o+="<ul>";r<t.length;){let c=t[r];if(c.indent<i)break;if(c.indent===i){if(c.isTask){let d=c.checked?"checked":"";o+=`<li class="task-item"><input type="checkbox" ${d} disabled>${E(c.content)}`}else o+=`<li>${E(c.content)}`;if(r+1<t.length&&t[r+1].indent>i){let d=e(t,r+1,t[r+1].indent);o+=d.html,r=d.endIdx}else r++;o+="</li>"}else r++}return o+=a==="ol"?"</ol>":"</ul>",{html:o,endIdx:r}};return e(s,0,s[0].indent).html}function ne(s){if(s.length<2)return"";let e=r=>r.trim().replace(/^\|/,"").replace(/\|$/,"").split("|").map(a=>a.trim()),t=e(s[0]),n=s[1].trim();if(!/^\|[\s\-:|]+\|$/.test(n))return s.map(r=>`<p>${E(r)}</p>`).join(`
`);let i=e(s[1]).map(r=>r.startsWith(":")&&r.endsWith(":")?"center":r.endsWith(":")?"right":"left"),o="<table><thead><tr>";t.forEach((r,a)=>{let l=i[a]||"left";o+=`<th style="text-align: ${l}">${E(r)}</th>`}),o+="</tr></thead><tbody>";for(let r=2;r<s.length;r++){let a=e(s[r]);o+="<tr>",a.forEach((l,c)=>{let d=i[c]||"left";o+=`<td style="text-align: ${d}">${E(l)}</td>`}),o+="</tr>"}return o+="</tbody></table>",o}function R(s){let t=M(s).split(`
`),n=[],i=[],o=!1,r=!1,a=[],l=[],c=[],d="",h=[],m=!1,p=[],g="",u=[],v=null,w=!1,O="",de=[],kt=0,he=[],Ue=()=>{l.length>0&&(n.push(Ht(l)),l=[])},Et=()=>{if(he.length>0){let A=he.map(f=>E(f)).join(`<br>
`);n.push(`<p>${A}</p>`),he=[]}},P=()=>{Ue(),Et()};for(let A=0;A<t.length;A++){let f=t[A],je=f.match(/^:::details\s*(.*)$/);if(je&&!o&&!r){P(),m=!0,g=je[1]||"\u8A73\u7D30",p=[];continue}if(f.trim()===":::"&&m&&!o&&!r){let b=R(p.join(`
`));n.push(`<details class="collapsible"><summary>${E(g)}</summary><div class="details-content">${b.html}</div></details>`),m=!1,p=[],g="";continue}if(m){p.push(f);continue}let Ve=f.match(/^:::note\s*(info|warn|alert)?$/i);if(Ve&&!o&&!r&&!w){P(),w=!0,O=(Ve[1]||"info").toLowerCase(),de=[];continue}if(f.trim()===":::"&&w&&!o&&!r){let b=R(de.join(`
`)),T=yt[O]||yt.info;n.push(`<div class="note note-${O}"><span class="note-icon">${T}</span><div class="note-content">${b.html}</div></div>`),w=!1,de=[],O="";continue}if(w){de.push(f);continue}if(f.startsWith("```")){if(o){if(d==="mermaid"){let b=h.join(`
`);n.push(`<div class="mermaid">${b}</div>`)}else n.push(`<pre><code class="language-${d}">${h.join(`
`)}</code></pre>`);h=[],o=!1,d=""}else d=f.slice(3).trim()||"text",o=!0;continue}if(o){d==="mermaid"?h.push(f):h.push($(f));continue}if(f.trim()==="$$"){if(r){let b=a.join(`
`);n.push(`<div class="math-block" data-math="${$(b)}"></div>`),a=[],r=!1}else P(),r=!0;continue}let _e=f.match(/^\$\$(.+)\$\$$/);if(_e){P(),n.push(`<div class="math-block" data-math="${$(_e[1])}"></div>`);continue}if(r){a.push(f);continue}let Pe=f.match(/^(#{1,6})\s+(.+)$/);if(Pe){P();let b=Pe[1].length,T=Pe[2],pe=`heading-${++kt}`;i.push({level:b,text:T,id:pe,line:A}),n.push(`<h${b} id="${pe}">${E(T)}</h${b}>`);continue}if(/^(---|\*\*\*|___)$/.test(f.trim())){P(),n.push("<hr>");continue}if(f.startsWith(">")){P(),c.length>0&&(n.push(ne(c)),c=[]);let b=f.slice(1).trim(),T=b.match(/^\[!(NOTE|TIP|IMPORTANT|WARNING|CAUTION)\]$/i);if(T&&u.length===0){v=T[1].toUpperCase(),u.push("");continue}u.push(b);continue}else if(u.length>0){let b=u.filter(T=>T).map(T=>E(T)).join("<br>");if(v){let T=bt[v];n.push(`<div class="alert alert-${v.toLowerCase()}"><span class="alert-title">${T} ${v}</span><p>${b}</p></div>`)}else n.push(`<blockquote>${b}</blockquote>`);u=[],v=null}if(f.trim().startsWith("|")&&f.trim().endsWith("|")){P(),c.push(f);continue}else c.length>0&&(n.push(ne(c)),c=[]);let me=f.match(/^(\s*)([-*+])\s+\[([ xX])\]\s+(.+)$/);if(me){let b=me[1].length,T=me[3].toLowerCase()==="x",pe=me[4];l.push({type:"ul",indent:b,content:pe,isTask:!0,checked:T});continue}let Ae=f.match(/^(\s*)([-*+])\s+(.+)$/);if(Ae){let b=Ae[1].length,T=Ae[3];l.push({type:"ul",indent:b,content:T,isTask:!1,checked:!1});continue}let Ne=f.match(/^(\s*)(\d+)\.\s+(.+)$/);if(Ne){let b=Ne[1].length,T=Ne[3];l.push({type:"ol",indent:b,content:T,isTask:!1,checked:!1});continue}if(f.trim()===""){P(),c.length>0&&(n.push(ne(c)),c=[]);continue}Ue(),c.length>0&&(n.push(ne(c)),c=[]),he.push(f)}if(P(),o&&n.push(`<pre><code class="language-${d||"text"}">${h.join(`
`)}</code></pre>`),c.length>0&&n.push(ne(c)),u.length>0){let A=u.filter(f=>f).map(f=>E(f)).join("<br>");if(v){let f=bt[v];n.push(`<div class="alert alert-${v.toLowerCase()}"><span class="alert-title">${f} ${v}</span><p>${A}</p></div>`)}else n.push(`<blockquote>${A}</blockquote>`)}return{html:n.join(`
`),toc:i}}var J=class{headingCount=0;parse(e){this.headingCount=0;let t=R(e);return{html:t.html,toc:t.toc}}parseInline(e){return E(e)}parseEmoji(e){return be(e)}generateToc(e){return R(e).toc}generateTocHtml(e){if(e.length===0)return"";let t='<div class="toc-list">';for(let n of e){let i=(n.level-1)*12;t+=`<div class="toc-entry toc-h${n.level}" style="padding-left: ${i}px" data-line="${n.line}">`,t+=n.text,t+="</div>"}return t+="</div>",t}},B=new J;var y={SESSIONS:"vim-md-sessions",SESSION_PREFIX:"vim-md-session-",CONTENT_PREFIX:"vim-md-content-",THEME:"vim-md-theme",FONT_SIZE:"vim-md-font-size",VIM_MODE:"vim-md-vim-mode",AUTO_SAVE:"vim-md-autosave"},Rt=10,X=class{sessionId;storageAvailable;constructor(){this.storageAvailable=this.checkStorageAvailability(),this.sessionId=this.initSessionId()}checkStorageAvailability(){try{let e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}}initSessionId(){if(!this.storageAvailable)return this.generateSessionId();try{let e=sessionStorage.getItem("vim-md-session-id");return e||(e=this.generateSessionId(),sessionStorage.setItem("vim-md-session-id",e)),e}catch{return this.generateSessionId()}}generateSessionId(){return"session-"+Date.now()+"-"+Math.random().toString(36).substr(2,9)}getSessionId(){return this.sessionId}isStorageAvailable(){return this.storageAvailable}saveSession(e,t){if(this.storageAvailable)try{sessionStorage.setItem(y.CONTENT_PREFIX+this.sessionId,e);let n={content:e,filename:t,timestamp:Date.now()};localStorage.setItem(y.SESSION_PREFIX+this.sessionId,JSON.stringify(n)),this.updateSessionList()}catch(n){console.warn("Failed to save session:",n)}}updateSessionList(){try{let e=[];try{e=JSON.parse(localStorage.getItem(y.SESSIONS)||"[]")}catch{e=[]}for(e.includes(this.sessionId)||e.push(this.sessionId);e.length>Rt;){let t=e.shift();t&&localStorage.removeItem(y.SESSION_PREFIX+t)}localStorage.setItem(y.SESSIONS,JSON.stringify(e))}catch(e){console.warn("Failed to update session list:",e)}}loadSession(){if(!this.storageAvailable)return null;try{let e=sessionStorage.getItem(y.CONTENT_PREFIX+this.sessionId);if(e){let n=this.getSessionData(this.sessionId);return{content:M(e),filename:n?.filename||"\u7121\u984C",timestamp:n?.timestamp||Date.now()}}let t=this.getSessionList();if(t.length>0){let n=null,i=0;for(let o of t){let r=this.getSessionData(o);r&&r.timestamp>i&&r.content&&(i=r.timestamp,n=r)}if(n)return{content:M(n.content),filename:n.filename,timestamp:n.timestamp}}return null}catch(e){return console.warn("Failed to load session:",e),null}}getSessionData(e){try{let t=localStorage.getItem(y.SESSION_PREFIX+e);return t?JSON.parse(t):null}catch{return null}}getSessionList(){try{return JSON.parse(localStorage.getItem(y.SESSIONS)||"[]")}catch{return[]}}clearSession(){if(this.storageAvailable)try{sessionStorage.removeItem(y.CONTENT_PREFIX+this.sessionId),localStorage.removeItem(y.SESSION_PREFIX+this.sessionId);let e=this.getSessionList().filter(t=>t!==this.sessionId);localStorage.setItem(y.SESSIONS,JSON.stringify(e))}catch(e){console.warn("Failed to clear session:",e)}}clearAllSessions(){if(this.storageAvailable)try{let e=this.getSessionList();for(let t of e)localStorage.removeItem(y.SESSION_PREFIX+t);localStorage.removeItem(y.SESSIONS),sessionStorage.removeItem(y.CONTENT_PREFIX+this.sessionId)}catch(e){console.warn("Failed to clear all sessions:",e)}}saveSettings(e){if(this.storageAvailable)try{e.theme!==void 0&&localStorage.setItem(y.THEME,e.theme),e.fontSize!==void 0&&localStorage.setItem(y.FONT_SIZE,String(e.fontSize)),e.vimMode!==void 0&&localStorage.setItem(y.VIM_MODE,String(e.vimMode)),e.autoSaveInterval!==void 0&&localStorage.setItem(y.AUTO_SAVE,e.autoSaveInterval)}catch(t){console.warn("Failed to save settings:",t)}}loadSettings(){let e={theme:"dark",fontSize:100,vimMode:!0,autoSaveInterval:"1s"};if(!this.storageAvailable)return e;try{let t=localStorage.getItem(y.THEME),n=localStorage.getItem(y.FONT_SIZE),i=localStorage.getItem(y.VIM_MODE),o=localStorage.getItem(y.AUTO_SAVE);return{theme:t||e.theme,fontSize:n?parseInt(n,10):e.fontSize,vimMode:i!==null?i==="true":e.vimMode,autoSaveInterval:o||e.autoSaveInterval}}catch{return e}}},F=new X;function G(s,e=1){let t=Math.max(0,s.selectionStart-e);s.selectionStart=t,s.selectionEnd=t}function z(s,e=1){let t=Math.min(s.value.length,s.selectionStart+e);s.selectionStart=t,s.selectionEnd=t}function ie(s,e=1){let t=s.value,n=s.selectionStart,i=I(t),o=0,r=0,a=0;for(let h=0;h<i.length;h++){if(a+i[h].length>=n){o=h,r=a;break}a+=i[h].length+1}let l=n-r,c=Math.max(0,o-e),d=0;for(let h=0;h<c;h++)d+=i[h].length+1;d+=Math.min(l,i[c]?.length||0),s.selectionStart=d,s.selectionEnd=d}function se(s,e=1){let t=s.value,n=s.selectionStart,i=I(t),o=0,r=0,a=0;for(let h=0;h<i.length;h++){if(a+i[h].length>=n){o=h,r=a;break}a+=i[h].length+1}let l=n-r,c=Math.min(i.length-1,o+e),d=0;for(let h=0;h<c;h++)d+=i[h].length+1;d+=Math.min(l,i[c]?.length||0),s.selectionStart=d,s.selectionEnd=d}function Q(s){let e=s.value,t=s.selectionStart,n=e.lastIndexOf(`
`,t-1)+1;s.selectionStart=n,s.selectionEnd=n}function W(s){let e=s.value,t=s.selectionStart,n=e.indexOf(`
`,t);n===-1&&(n=e.length),s.selectionStart=n,s.selectionEnd=n}function D(s){let e=s.value,t=s.selectionStart,n=e.lastIndexOf(`
`,t-1)+1,i=e.indexOf(`
`,t);i===-1&&(i=e.length);let r=e.substring(n,i).match(/^\s*/),a=n+(r?r[0].length:0);s.selectionStart=a,s.selectionEnd=a}function ye(s,e=1){let t=s.value,n=s.selectionStart;for(let i=0;i<e&&n<t.length;i++){for(;n<t.length&&N(t[n]);)n++;for(;n<t.length&&H(t[n]);)n++;for(;n<t.length&&!N(t[n])&&!H(t[n]);)n++}s.selectionStart=n,s.selectionEnd=n}function we(s,e=1){let t=s.value,n=s.selectionStart;for(let i=0;i<e&&n>0;i++){for(n--;n>0&&H(t[n]);)n--;for(;n>0&&N(t[n-1]);)n--}s.selectionStart=n,s.selectionEnd=n}function Oe(s,e=1){let t=s.value,n=s.selectionStart;for(let i=0;i<e&&n<t.length;i++){for(n++;n<t.length&&H(t[n]);)n++;for(;n<t.length-1&&N(t[n+1]);)n++}s.selectionStart=n,s.selectionEnd=n}function $e(s,e=1){let t=s.value,n=s.selectionStart;for(let i=0;i<e&&n>0;i++){for(n--;n>0&&H(t[n]);)n--;if(n>0&&N(t[n])){for(;n>0&&N(t[n-1]);)n--;if(n>0)for(n--;n>0&&H(t[n]);)n--}}s.selectionStart=n,s.selectionEnd=n}function Me(s){s.selectionStart=0,s.selectionEnd=0}function Le(s){let e=s.value.length;s.selectionStart=e,s.selectionEnd=e}function Te(s,e){let t=I(s.value),n=Math.max(0,Math.min(e-1,t.length-1)),i=0;for(let o=0;o<n;o++)i+=t[o].length+1;s.selectionStart=i,s.selectionEnd=i}function Y(s,e,t,n=!1,i=1){let o=s.value,r=s.selectionStart,a=o.lastIndexOf(`
`,r-1)+1,l=o.indexOf(`
`,r);l===-1&&(l=o.length);let c=!1;for(let d=0;d<i;d++)if(t===1){let h=r+1,m=o.indexOf(e,h);m!==-1&&m<l&&(r=n?m-1:m,c=!0)}else{let h=r,p=o.substring(a,h).lastIndexOf(e);p!==-1&&(r=a+p+(n?1:0),c=!0)}return c&&(s.selectionStart=r,s.selectionEnd=r),c}function Be(s){let e=s.value,t=s.selectionStart,n=e[t],i={"(":")",")":"(","[":"]","]":"[","{":"}","}":"{","<":">",">":"<"};if(!i[n])return!1;let o="([{<".includes(n),r=i[n],a=1,l=t+(o?1:-1);for(;l>=0&&l<e.length&&a>0;)e[l]===n&&a++,e[l]===r&&a--,a>0&&(l+=o?1:-1);return a===0?(s.selectionStart=l,s.selectionEnd=l,!0):!1}function wt(s){return ue(s.value,s.selectionStart)}function Mt(s){let e=s.value,t=s.selectionStart,n=e.lastIndexOf(`
`,t-1)+1;return t-n}function We(s){return{line:wt(s)+1,column:Mt(s)+1,position:s.selectionStart}}function x(s,e){let t=s.selectionStart,n=s.selectionEnd,i=s.value.substring(0,t),o=s.value.substring(n);s.value=i+e+o;let r=t+e.length;s.selectionStart=r,s.selectionEnd=r}function K(s,e,t){let n=s.value,i=n.substring(e,t);return s.value=n.substring(0,e)+n.substring(t),s.selectionStart=e,s.selectionEnd=e,i}function U(s,e=1){let t=s.value,n=s.selectionStart,i=I(t),o=0,r=0;for(let p=0;p<i.length;p++){if(r+i[p].length>=n){o=p;break}r+=i[p].length+1}let a=o,l=Math.min(o+e,i.length),d=i.slice(a,l).join(`
`)+`
`,h=[...i.slice(0,a),...i.slice(l)];s.value=h.join(`
`);let m=0;for(let p=0;p<a&&p<h.length;p++)m+=h[p].length+1;return s.selectionStart=m,s.selectionEnd=m,d}function Z(s,e=!0){let t=s.value,n=s.selectionStart;if(e){let i=n;for(;i<t.length&&/\w/.test(t[i]);)i++;for(;i<t.length&&/\s/.test(t[i]);)i++;return i===n&&(i=n+1),K(s,n,i)}else{let i=n;for(;i>0&&/\s/.test(t[i-1]);)i--;for(;i>0&&/\w/.test(t[i-1]);)i--;return i===n&&(i=Math.max(0,n-1)),K(s,i,n)}}function j(s){let e=s.value,t=s.selectionStart,n=e.indexOf(`
`,t);return n===-1&&(n=e.length),K(s,t,n)}function oe(s,e=1){let t=s.value,n=s.selectionStart,i=I(t),o=0,r=0;for(let c=0;c<i.length;c++){if(r+i[c].length>=n){o=c;break}r+=i[c].length+1}let a=Math.min(o+e,i.length);return i.slice(o,a).join(`
`)+`
`}function ke(s,e){let t=M(e);if(t.endsWith(`
`)){let n=s.value,i=n.indexOf(`
`,s.selectionStart);i===-1&&(i=n.length),s.selectionStart=i,s.selectionEnd=i,x(s,`
`+t.slice(0,-1))}else s.selectionStart++,s.selectionEnd=s.selectionStart,x(s,t)}function Ee(s,e){let t=M(e);if(t.endsWith(`
`)){let i=s.value.lastIndexOf(`
`,s.selectionStart-1)+1;s.selectionStart=i,s.selectionEnd=i,x(s,t),s.selectionStart=i,s.selectionEnd=i}else x(s,t)}function re(s,e=1){let t=s.value,n=s.selectionStart;for(let i=0;i<e;i++){let o=s.value.indexOf(`
`,s.selectionStart);if(o===-1)break;let a=o+1;for(;a<s.value.length&&/\s/.test(s.value[a])&&s.value[a]!==`
`;)a++;s.value=s.value.substring(0,o)+" "+s.value.substring(a),s.selectionStart=o,s.selectionEnd=o}}function ae(s,e=1){let t=s.value,n=s.selectionStart,i=Math.min(n+e,t.length),o="";for(let r=n;r<i;r++){let a=t[r];a===a.toLowerCase()?o+=a.toUpperCase():o+=a.toLowerCase()}s.value=t.substring(0,n)+o+t.substring(i),s.selectionStart=i,s.selectionEnd=i}function ee(s,e=1,t=2){let n=s.value,i=s.selectionStart,o=n.lastIndexOf(`
`,i-1)+1,r=" ".repeat(t*e);s.value=n.substring(0,o)+r+n.substring(o),s.selectionStart=i+r.length,s.selectionEnd=s.selectionStart}function V(s,e=1,t=2){let n=s.value,i=s.selectionStart,o=n.lastIndexOf(`
`,i-1)+1,r=o;for(;r<n.length&&n[r]===" ";)r++;let a=r-o,l=Math.min(a,t*e);l>0&&(s.value=n.substring(0,o)+n.substring(o+l),s.selectionStart=Math.max(o,i-l),s.selectionEnd=s.selectionStart)}function xe(s,e,t=100){e.push({text:s.value,pos:s.selectionStart}),e.length>t&&e.shift()}function Ce(s,e,t){if(e.length===0)return!1;t.push({text:s.value,pos:s.selectionStart});let n=e.pop();return s.value=n.text,s.selectionStart=n.pos,s.selectionEnd=n.pos,!0}function Ie(s,e,t){if(t.length===0)return!1;e.push({text:s.value,pos:s.selectionStart});let n=t.pop();return s.value=n.text,s.selectionStart=n.pos,s.selectionEnd=n.pos,!0}function k(s,e,t='"',n=!1){if(s['"']=e,n||(s[0]=e),t!=='"'&&/[a-zA-Z]/.test(t))if(t===t.toUpperCase()){let i=t.toLowerCase();s[i]=(s[i]||"")+e}else s[t]=e;!n&&e&&navigator.clipboard&&navigator.clipboard.writeText(e).catch(()=>{})}function _(s,e='"'){return e==='"'?s['"']||"":s[e.toLowerCase()]||s['"']||""}var Fe=new Map;function C(s){if(Fe.set(s.name,s),s.aliases)for(let e of s.aliases)Fe.set(e,s)}function Lt(s){return Fe.get(s)}async function Ke(s,e){let t=s.trim();if(!t)return{success:!1,message:""};if(/^\d+$/.test(t)){let l=parseInt(t,10);return e.gotoLine(l),{success:!0,message:`Line ${l}`}}let n=t.match(/^(\S+)(?:\s+(.*))?$/);if(!n)return{success:!1,message:"Invalid command"};let[,i,o=""]=n,r=t.match(/^(%)?s\/([^/]*)\/([^/]*)\/([gi]*)$/);if(r){let[,l,c,d,h]=r;return Dt(e,c,d,h,!!l)}let a=Lt(i);if(a)try{return await a.handler(o),{success:!0}}catch(l){return{success:!1,message:String(l)}}return{success:!1,message:`Unknown command: ${i}`}}function Dt(s,e,t,n,i){if(!e)return{success:!1,message:"No pattern specified"};let o=s.editor,r=o.value,a=n.includes("i")?"gi":"g",l=new RegExp(e,a),c,d=0;if(i)c=r.replace(l,()=>(d++,t));else{let h=o.selectionStart,m=r.lastIndexOf(`
`,h-1)+1,p=r.indexOf(`
`,h);p===-1&&(p=r.length);let g=r.substring(m,p),u=n.includes("g")?g.replace(l,()=>(d++,t)):g.replace(new RegExp(e,n.includes("i")?"i":""),()=>(d++,t));c=r.substring(0,m)+u+r.substring(p)}return d>0?(s.saveState(),o.value=c,s.updatePreview(),{success:!0,message:`${d} substitution(s)`}):{success:!1,message:"Pattern not found"}}function ze(s){C({name:"w",aliases:["write","save"],handler:()=>s.saveFile(),description:"Save file"}),C({name:"e",aliases:["edit"],handler:e=>{if(e){if(s.isModified()){s.showStatus("No write since last change (add ! to override)",!0);return}s.editFile(e,!1)}else{if(s.isModified()){s.showStatus("No write since last change (add ! to override)",!0);return}s.openFile()}},description:"Edit file (create new if not exists)"}),C({name:"e!",aliases:["edit!"],handler:e=>{e?s.editFile(e,!0):s.openFile()},description:"Edit file (discard changes)"}),C({name:"new",handler:()=>s.newFile(),description:"New file"}),C({name:"q",aliases:["quit","exit"],handler:()=>s.quit(),description:"Quit"}),C({name:"wq",handler:()=>{s.saveFile(),s.quit()},description:"Save and quit"}),C({name:"theme",handler:e=>{e&&s.setTheme(e)},description:"Set theme (dark/light/original)"}),C({name:"help",aliases:["h"],handler:()=>{let e=document.getElementById("help-modal");e&&e.classList.remove("hidden")},description:"Show help"}),C({name:"set",handler:e=>{let t=e.split(/\s+/),n=t[0],i=t[1];switch(n){case"vim":s.setVimMode(!0),s.showStatus("VIM mode enabled");break;case"novim":s.setVimMode(!1),s.showStatus("VIM mode disabled");break;case"wrap":s.setWrap(!0),s.showStatus("Word wrap enabled");break;case"nowrap":s.setWrap(!1),s.showStatus("Word wrap disabled");break;default:s.showStatus(`Unknown option: ${n}`,!0)}},description:"Set options"}),C({name:"export",handler:async e=>{let t=e?.trim().split(/\s+/)[0]?.toLowerCase();if(!t){s.showStatus("Usage: :export [md|html|docx]",!0);return}await s.exportAs(t)},description:"Export document (:export md|html|docx)"}),C({name:"images",handler:()=>{let e=s.getImageCount();s.showStatus(`${e} image(s) embedded`)},description:"Show embedded image count"}),C({name:"import",aliases:["read"],handler:async e=>{let t=e?.trim();if(!t){s.showStatus("Usage: :import [file|clipboard|<url>]",!0);return}t==="file"?s.openImportDialog():t==="clipboard"?await s.importFromClipboard():await s.importFromUrl(t)},description:"Import from file/clipboard/URL (:import file|clipboard|<url>)"})}function Ot(s){let e=s.toLowerCase(),t=[];for(let[n]of Fe)n.startsWith(e)&&t.push(n);return t.sort()}var le=class{history=[];index=-1;maxSize;constructor(e=50){this.maxSize=e}add(e){e&&e!==this.history[this.history.length-1]&&(this.history.push(e),this.history.length>this.maxSize&&this.history.shift()),this.index=this.history.length}previous(){if(this.index>0)return this.index--,this.history[this.index]}next(){return this.index<this.history.length-1?(this.index++,this.history[this.index]):(this.index=this.history.length,"")}reset(){this.index=this.history.length}};var ce={en:{appTitle:"mdvim - Vim-style Markdown Editor",edit:"Edit",preview:"Preview",split:"Split",fontSmaller:"Smaller font",fontLarger:"Larger font",toc:"Table of Contents",closeToc:"Close TOC",openToc:"Open TOC",vimModeToggle:"VIM/Edit mode toggle",foldAll:"\u25B6 Fold All",unfoldAll:"\u25BC Unfold All",untitled:"Untitled",helpHint:":help to show help",modified:"[Modified]",saved:"Saved",opened:"Opened",newFile:"New file",undone:"Undone",redone:"Redone",noMoreUndo:"Nothing to undo",noMoreRedo:"Nothing to redo",yanked:"Yanked",notFound:"Not found",replaced:"Replaced",macroRecording:"Recording @",macroSaved:"Macro saved to @",macroPlayed:"Macro played",markSet:"Mark '%s' set",helpTitle:"\u2328\uFE0F Keybinding Help",helpModeSwitch:"Mode Switch",helpMovement:"Movement",helpEditing:"Editing",helpTextObjects:"Text Objects",helpMarksAndMacros:"Marks & Macros",helpSearchReplace:"Search & Replace",helpCommands:"Commands",helpMarkdown:"Markdown",helpClose:"Close (Esc)",helpInsertAtCursor:"Insert (at cursor)",helpInsertAtLineStart:"Insert (line start)",helpInsertAfterCursor:"Insert (after cursor)",helpInsertAtLineEnd:"Insert (line end)",helpInsertLineBelow:"Insert line below",helpInsertLineAbove:"Insert line above",helpVisualMode:"Visual mode",helpVisualLineMode:"Visual line mode",helpToNormal:"To normal mode",helpCommandMode:"Command mode",helpLeftDownUpRight:"Left/Down/Up/Right",helpWordMovement:"Word (next/prev)",helpWordEnd:"Word end",helpLineStartEnd:"Line start/end",helpFirstNonBlank:"First non-blank",helpFileStartEnd:"File start/end",helpFindChar:"Find char in line",helpMatchingBracket:"Matching bracket",helpPageMovement:"Page movement",helpHalfPageMovement:"Half page",helpDeleteChar:"Delete char",helpDelete:"Delete",helpChange:"Change",helpYank:"Yank",helpPaste:"Paste",helpUndoRedo:"Undo/Redo",helpRepeatEdit:"Repeat last edit",helpToggleCase:"Toggle case",helpJoinLines:"Join lines",helpIndent:"Indent",helpDeleteWord:"Delete word",helpDeleteInQuotes:'Delete in "..."',helpDeleteInParens:"Delete in (...)",helpDeleteInBrackets:"Delete in [...]",helpDeleteInBraces:"Delete in {...}",helpSetMark:"Set mark",helpGoToMark:"Go to mark",helpRecordMacro:"Record macro",helpPlayMacro:"Play macro",helpForwardSearch:"Forward search",helpNextPrev:"Next/Prev match",helpSearchWord:"Search word under cursor",helpReplaceLine:"Replace (current line)",helpReplaceAll:"Replace all",helpSave:"Save",helpOpen:"Open file",helpNew:"New file",helpQuit:"Quit",helpHelp:"Show help",helpInlineMath:"Inline math",helpBlockMath:"Block math",helpMermaid:"Mermaid diagram",helpDetails:"Collapsible",language:"Language"},ja:{appTitle:"mdvim - Vim\u98A8\u30DE\u30FC\u30AF\u30C0\u30A6\u30F3\u30A8\u30C7\u30A3\u30BF",edit:"\u7DE8\u96C6",preview:"\u30D7\u30EC\u30D3\u30E5\u30FC",split:"\u5206\u5272",fontSmaller:"\u6587\u5B57\u3092\u5C0F\u3055\u304F",fontLarger:"\u6587\u5B57\u3092\u5927\u304D\u304F",toc:"\u76EE\u6B21",closeToc:"\u76EE\u6B21\u3092\u9589\u3058\u308B",openToc:"\u76EE\u6B21\u3092\u958B\u304F",vimModeToggle:"VIM/\u7DE8\u96C6\u30E2\u30FC\u30C9\u5207\u66FF",foldAll:"\u25B6 \u5168\u3066\u6298\u308A\u305F\u305F\u3080",unfoldAll:"\u25BC \u5168\u3066\u5C55\u958B",untitled:"\u7121\u984C",helpHint:":help \u3067\u30D8\u30EB\u30D7\u3092\u8868\u793A",modified:"[\u5909\u66F4\u3042\u308A]",saved:"\u4FDD\u5B58\u3057\u307E\u3057\u305F",opened:"\u958B\u304D\u307E\u3057\u305F",newFile:"\u65B0\u898F\u30D5\u30A1\u30A4\u30EB",undone:"\u5143\u306B\u623B\u3057\u307E\u3057\u305F",redone:"\u3084\u308A\u76F4\u3057\u307E\u3057\u305F",noMoreUndo:"\u3053\u308C\u4EE5\u4E0A\u623B\u305B\u307E\u305B\u3093",noMoreRedo:"\u3053\u308C\u4EE5\u4E0A\u3084\u308A\u76F4\u305B\u307E\u305B\u3093",yanked:"\u30E4\u30F3\u30AF\u3057\u307E\u3057\u305F",notFound:"\u898B\u3064\u304B\u308A\u307E\u305B\u3093",replaced:"\u7F6E\u63DB\u3057\u307E\u3057\u305F",macroRecording:"\u8A18\u9332\u4E2D @",macroSaved:"\u30DE\u30AF\u30ED\u3092\u4FDD\u5B58: @",macroPlayed:"\u30DE\u30AF\u30ED\u518D\u751F",markSet:"\u30DE\u30FC\u30AF '%s' \u3092\u8A2D\u5B9A\u3057\u307E\u3057\u305F",helpTitle:"\u2328\uFE0F \u30AD\u30FC\u30D0\u30A4\u30F3\u30C9\u30D8\u30EB\u30D7",helpModeSwitch:"\u30E2\u30FC\u30C9\u5207\u66FF",helpMovement:"\u79FB\u52D5",helpEditing:"\u7DE8\u96C6",helpTextObjects:"\u30C6\u30AD\u30B9\u30C8\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8",helpMarksAndMacros:"\u30DE\u30FC\u30AF\u30FB\u30DE\u30AF\u30ED",helpSearchReplace:"\u691C\u7D22\u30FB\u7F6E\u63DB",helpCommands:"\u30B3\u30DE\u30F3\u30C9",helpMarkdown:"Markdown",helpClose:"\u9589\u3058\u308B (Esc)",helpInsertAtCursor:"\u633F\u5165\u30E2\u30FC\u30C9\uFF08\u30AB\u30FC\u30BD\u30EB\u4F4D\u7F6E\uFF09",helpInsertAtLineStart:"\u633F\u5165\u30E2\u30FC\u30C9\uFF08\u884C\u982D\uFF09",helpInsertAfterCursor:"\u633F\u5165\u30E2\u30FC\u30C9\uFF08\u30AB\u30FC\u30BD\u30EB\u5F8C\uFF09",helpInsertAtLineEnd:"\u633F\u5165\u30E2\u30FC\u30C9\uFF08\u884C\u672B\uFF09",helpInsertLineBelow:"\u4E0B\u306B\u65B0\u3057\u3044\u884C\u3092\u633F\u5165",helpInsertLineAbove:"\u4E0A\u306B\u65B0\u3057\u3044\u884C\u3092\u633F\u5165",helpVisualMode:"\u30D3\u30B8\u30E5\u30A2\u30EB\u30E2\u30FC\u30C9",helpVisualLineMode:"\u884C\u30D3\u30B8\u30E5\u30A2\u30EB\u30E2\u30FC\u30C9",helpToNormal:"\u30CE\u30FC\u30DE\u30EB\u3078",helpCommandMode:"\u30B3\u30DE\u30F3\u30C9\u30E2\u30FC\u30C9",helpLeftDownUpRight:"\u5DE6/\u4E0B/\u4E0A/\u53F3",helpWordMovement:"\u5358\u8A9E\u79FB\u52D5\uFF08\u6B21/\u524D\uFF09",helpWordEnd:"\u5358\u8A9E\u672B\u5C3E\u3078",helpLineStartEnd:"\u884C\u982D/\u884C\u672B",helpFirstNonBlank:"\u6700\u521D\u306E\u975E\u7A7A\u767D\u6587\u5B57\u3078",helpFileStartEnd:"\u30D5\u30A1\u30A4\u30EB\u5148\u982D/\u672B\u5C3E",helpFindChar:"\u884C\u5185\u3067\u6587\u5B57\u3078",helpMatchingBracket:"\u5BFE\u5FDC\u62EC\u5F27\u3078\u30B8\u30E3\u30F3\u30D7",helpPageMovement:"1\u30DA\u30FC\u30B8\u79FB\u52D5",helpHalfPageMovement:"\u534A\u30DA\u30FC\u30B8\u79FB\u52D5",helpDeleteChar:"\u6587\u5B57\u524A\u9664",helpDelete:"\u524A\u9664",helpChange:"\u5909\u66F4",helpYank:"\u30E4\u30F3\u30AF",helpPaste:"\u8CBC\u308A\u4ED8\u3051",helpUndoRedo:"\u30A2\u30F3\u30C9\u30A5/\u30EA\u30C9\u30A5",helpRepeatEdit:"\u76F4\u524D\u306E\u7DE8\u96C6\u3092\u7E70\u308A\u8FD4\u3057",helpToggleCase:"\u5927\u6587\u5B57/\u5C0F\u6587\u5B57\u5207\u66FF",helpJoinLines:"\u884C\u3092\u7D50\u5408",helpIndent:"\u30A4\u30F3\u30C7\u30F3\u30C8",helpDeleteWord:"\u5358\u8A9E\u524A\u9664",helpDeleteInQuotes:'"..."\u5185\u3092\u524A\u9664',helpDeleteInParens:"(...)\u5185\u3092\u524A\u9664",helpDeleteInBrackets:"[...]\u5185\u3092\u524A\u9664",helpDeleteInBraces:"{...}\u5185\u3092\u524A\u9664",helpSetMark:"\u4F4D\u7F6E\u3092\u30DE\u30FC\u30AF",helpGoToMark:"\u30DE\u30FC\u30AF\u884C\u982D\u3078",helpRecordMacro:"\u30DE\u30AF\u30ED\u8A18\u9332\u958B\u59CB/\u7D42\u4E86",helpPlayMacro:"\u30DE\u30AF\u30ED\u518D\u751F",helpForwardSearch:"\u524D\u65B9\u691C\u7D22",helpNextPrev:"\u6B21/\u524D\u306E\u691C\u7D22\u7D50\u679C",helpSearchWord:"\u30AB\u30FC\u30BD\u30EB\u4E0B\u306E\u5358\u8A9E\u3092\u691C\u7D22",helpReplaceLine:"\u7F6E\u63DB\uFF08\u73FE\u5728\u884C\uFF09",helpReplaceAll:"\u5168\u7F6E\u63DB",helpSave:"\u4FDD\u5B58",helpOpen:"\u30D5\u30A1\u30A4\u30EB\u3092\u958B\u304F",helpNew:"\u65B0\u898F\u30D5\u30A1\u30A4\u30EB",helpQuit:"\u7D42\u4E86",helpHelp:"\u30D8\u30EB\u30D7\u8868\u793A",helpInlineMath:"\u30A4\u30F3\u30E9\u30A4\u30F3\u6570\u5F0F",helpBlockMath:"\u30D6\u30ED\u30C3\u30AF\u6570\u5F0F",helpMermaid:"Mermaid\u56F3",helpDetails:"\u6298\u308A\u7573\u307F",language:"\u8A00\u8A9E"},ko:{appTitle:"mdvim - Vim \uC2A4\uD0C0\uC77C \uB9C8\uD06C\uB2E4\uC6B4 \uC5D0\uB514\uD130",edit:"\uD3B8\uC9D1",preview:"\uBBF8\uB9AC\uBCF4\uAE30",split:"\uBD84\uD560",fontSmaller:"\uAE00\uAF34 \uCD95\uC18C",fontLarger:"\uAE00\uAF34 \uD655\uB300",toc:"\uBAA9\uCC28",closeToc:"\uBAA9\uCC28 \uB2EB\uAE30",openToc:"\uBAA9\uCC28 \uC5F4\uAE30",vimModeToggle:"VIM/\uD3B8\uC9D1 \uBAA8\uB4DC \uC804\uD658",foldAll:"\u25B6 \uBAA8\uB450 \uC811\uAE30",unfoldAll:"\u25BC \uBAA8\uB450 \uD3BC\uCE58\uAE30",untitled:"\uC81C\uBAA9 \uC5C6\uC74C",helpHint:":help \uB85C \uB3C4\uC6C0\uB9D0 \uBCF4\uAE30",modified:"[\uC218\uC815\uB428]",saved:"\uC800\uC7A5\uB428",opened:"\uC5F4\uB9BC",newFile:"\uC0C8 \uD30C\uC77C",undone:"\uC2E4\uD589 \uCDE8\uC18C\uB428",redone:"\uB2E4\uC2DC \uC2E4\uD589\uB428",noMoreUndo:"\uB354 \uC774\uC0C1 \uCDE8\uC18C\uD560 \uC218 \uC5C6\uC74C",noMoreRedo:"\uB354 \uC774\uC0C1 \uB2E4\uC2DC \uC2E4\uD589\uD560 \uC218 \uC5C6\uC74C",yanked:"\uBCF5\uC0AC\uB428",notFound:"\uCC3E\uC744 \uC218 \uC5C6\uC74C",replaced:"\uB300\uCCB4\uB428",macroRecording:"\uB179\uD654 \uC911 @",macroSaved:"\uB9E4\uD06C\uB85C \uC800\uC7A5: @",macroPlayed:"\uB9E4\uD06C\uB85C \uC7AC\uC0DD\uB428",markSet:"\uB9C8\uD06C '%s' \uC124\uC815\uB428",helpTitle:"\u2328\uFE0F \uD0A4 \uBC14\uC778\uB529 \uB3C4\uC6C0\uB9D0",helpModeSwitch:"\uBAA8\uB4DC \uC804\uD658",helpMovement:"\uC774\uB3D9",helpEditing:"\uD3B8\uC9D1",helpTextObjects:"\uD14D\uC2A4\uD2B8 \uAC1D\uCCB4",helpMarksAndMacros:"\uB9C8\uD06C & \uB9E4\uD06C\uB85C",helpSearchReplace:"\uAC80\uC0C9 & \uB300\uCCB4",helpCommands:"\uBA85\uB839\uC5B4",helpMarkdown:"Markdown",helpClose:"\uB2EB\uAE30 (Esc)",helpInsertAtCursor:"\uC0BD\uC785 (\uCEE4\uC11C \uC704\uCE58)",helpInsertAtLineStart:"\uC0BD\uC785 (\uC904 \uC2DC\uC791)",helpInsertAfterCursor:"\uC0BD\uC785 (\uCEE4\uC11C \uB4A4)",helpInsertAtLineEnd:"\uC0BD\uC785 (\uC904 \uB05D)",helpInsertLineBelow:"\uC544\uB798\uC5D0 \uC0C8 \uC904 \uC0BD\uC785",helpInsertLineAbove:"\uC704\uC5D0 \uC0C8 \uC904 \uC0BD\uC785",helpVisualMode:"\uBE44\uC8FC\uC5BC \uBAA8\uB4DC",helpVisualLineMode:"\uC904 \uBE44\uC8FC\uC5BC \uBAA8\uB4DC",helpToNormal:"\uB178\uBA40 \uBAA8\uB4DC\uB85C",helpCommandMode:"\uBA85\uB839 \uBAA8\uB4DC",helpLeftDownUpRight:"\uC67C\uCABD/\uC544\uB798/\uC704/\uC624\uB978\uCABD",helpWordMovement:"\uB2E8\uC5B4 (\uB2E4\uC74C/\uC774\uC804)",helpWordEnd:"\uB2E8\uC5B4 \uB05D",helpLineStartEnd:"\uC904 \uC2DC\uC791/\uB05D",helpFirstNonBlank:"\uCCAB \uBC88\uC9F8 \uBE44\uACF5\uBC31",helpFileStartEnd:"\uD30C\uC77C \uC2DC\uC791/\uB05D",helpFindChar:"\uC904\uC5D0\uC11C \uBB38\uC790 \uCC3E\uAE30",helpMatchingBracket:"\uC9DD \uAD04\uD638\uB85C",helpPageMovement:"\uD398\uC774\uC9C0 \uC774\uB3D9",helpHalfPageMovement:"\uBC18 \uD398\uC774\uC9C0",helpDeleteChar:"\uBB38\uC790 \uC0AD\uC81C",helpDelete:"\uC0AD\uC81C",helpChange:"\uBCC0\uACBD",helpYank:"\uBCF5\uC0AC",helpPaste:"\uBD99\uC5EC\uB123\uAE30",helpUndoRedo:"\uC2E4\uD589 \uCDE8\uC18C/\uB2E4\uC2DC \uC2E4\uD589",helpRepeatEdit:"\uB9C8\uC9C0\uB9C9 \uD3B8\uC9D1 \uBC18\uBCF5",helpToggleCase:"\uB300\uC18C\uBB38\uC790 \uC804\uD658",helpJoinLines:"\uC904 \uD569\uCE58\uAE30",helpIndent:"\uB4E4\uC5EC\uC4F0\uAE30",helpDeleteWord:"\uB2E8\uC5B4 \uC0AD\uC81C",helpDeleteInQuotes:'"..." \uC548 \uC0AD\uC81C',helpDeleteInParens:"(...) \uC548 \uC0AD\uC81C",helpDeleteInBrackets:"[...] \uC548 \uC0AD\uC81C",helpDeleteInBraces:"{...} \uC548 \uC0AD\uC81C",helpSetMark:"\uB9C8\uD06C \uC124\uC815",helpGoToMark:"\uB9C8\uD06C\uB85C \uC774\uB3D9",helpRecordMacro:"\uB9E4\uD06C\uB85C \uB179\uD654",helpPlayMacro:"\uB9E4\uD06C\uB85C \uC7AC\uC0DD",helpForwardSearch:"\uC55E\uC73C\uB85C \uAC80\uC0C9",helpNextPrev:"\uB2E4\uC74C/\uC774\uC804 \uACB0\uACFC",helpSearchWord:"\uCEE4\uC11C \uC544\uB798 \uB2E8\uC5B4 \uAC80\uC0C9",helpReplaceLine:"\uB300\uCCB4 (\uD604\uC7AC \uC904)",helpReplaceAll:"\uC804\uCCB4 \uB300\uCCB4",helpSave:"\uC800\uC7A5",helpOpen:"\uD30C\uC77C \uC5F4\uAE30",helpNew:"\uC0C8 \uD30C\uC77C",helpQuit:"\uC885\uB8CC",helpHelp:"\uB3C4\uC6C0\uB9D0 \uD45C\uC2DC",helpInlineMath:"\uC778\uB77C\uC778 \uC218\uC2DD",helpBlockMath:"\uBE14\uB85D \uC218\uC2DD",helpMermaid:"Mermaid \uB2E4\uC774\uC5B4\uADF8\uB7A8",helpDetails:"\uC811\uC744 \uC218 \uC788\uB294",language:"\uC5B8\uC5B4"},"zh-CN":{appTitle:"mdvim - Vim\u98CE\u683CMarkdown\u7F16\u8F91\u5668",edit:"\u7F16\u8F91",preview:"\u9884\u89C8",split:"\u5206\u5272",fontSmaller:"\u7F29\u5C0F\u5B57\u4F53",fontLarger:"\u653E\u5927\u5B57\u4F53",toc:"\u76EE\u5F55",closeToc:"\u5173\u95ED\u76EE\u5F55",openToc:"\u6253\u5F00\u76EE\u5F55",vimModeToggle:"VIM/\u7F16\u8F91\u6A21\u5F0F\u5207\u6362",foldAll:"\u25B6 \u5168\u90E8\u6298\u53E0",unfoldAll:"\u25BC \u5168\u90E8\u5C55\u5F00",untitled:"\u65E0\u6807\u9898",helpHint:":help \u663E\u793A\u5E2E\u52A9",modified:"[\u5DF2\u4FEE\u6539]",saved:"\u5DF2\u4FDD\u5B58",opened:"\u5DF2\u6253\u5F00",newFile:"\u65B0\u5EFA\u6587\u4EF6",undone:"\u5DF2\u64A4\u9500",redone:"\u5DF2\u91CD\u505A",noMoreUndo:"\u65E0\u6CD5\u7EE7\u7EED\u64A4\u9500",noMoreRedo:"\u65E0\u6CD5\u7EE7\u7EED\u91CD\u505A",yanked:"\u5DF2\u590D\u5236",notFound:"\u672A\u627E\u5230",replaced:"\u5DF2\u66FF\u6362",macroRecording:"\u5F55\u5236\u4E2D @",macroSaved:"\u5B8F\u5DF2\u4FDD\u5B58: @",macroPlayed:"\u5B8F\u5DF2\u64AD\u653E",markSet:"\u6807\u8BB0 '%s' \u5DF2\u8BBE\u7F6E",helpTitle:"\u2328\uFE0F \u5FEB\u6377\u952E\u5E2E\u52A9",helpModeSwitch:"\u6A21\u5F0F\u5207\u6362",helpMovement:"\u79FB\u52A8",helpEditing:"\u7F16\u8F91",helpTextObjects:"\u6587\u672C\u5BF9\u8C61",helpMarksAndMacros:"\u6807\u8BB0 & \u5B8F",helpSearchReplace:"\u641C\u7D22 & \u66FF\u6362",helpCommands:"\u547D\u4EE4",helpMarkdown:"Markdown",helpClose:"\u5173\u95ED (Esc)",helpInsertAtCursor:"\u63D2\u5165\uFF08\u5149\u6807\u4F4D\u7F6E\uFF09",helpInsertAtLineStart:"\u63D2\u5165\uFF08\u884C\u9996\uFF09",helpInsertAfterCursor:"\u63D2\u5165\uFF08\u5149\u6807\u540E\uFF09",helpInsertAtLineEnd:"\u63D2\u5165\uFF08\u884C\u5C3E\uFF09",helpInsertLineBelow:"\u5728\u4E0B\u65B9\u63D2\u5165\u65B0\u884C",helpInsertLineAbove:"\u5728\u4E0A\u65B9\u63D2\u5165\u65B0\u884C",helpVisualMode:"\u53EF\u89C6\u6A21\u5F0F",helpVisualLineMode:"\u884C\u53EF\u89C6\u6A21\u5F0F",helpToNormal:"\u8FD4\u56DE\u666E\u901A\u6A21\u5F0F",helpCommandMode:"\u547D\u4EE4\u6A21\u5F0F",helpLeftDownUpRight:"\u5DE6/\u4E0B/\u4E0A/\u53F3",helpWordMovement:"\u5355\u8BCD\uFF08\u4E0B\u4E00\u4E2A/\u4E0A\u4E00\u4E2A\uFF09",helpWordEnd:"\u5355\u8BCD\u672B\u5C3E",helpLineStartEnd:"\u884C\u9996/\u884C\u5C3E",helpFirstNonBlank:"\u7B2C\u4E00\u4E2A\u975E\u7A7A\u767D\u5B57\u7B26",helpFileStartEnd:"\u6587\u4EF6\u5F00\u5934/\u7ED3\u5C3E",helpFindChar:"\u884C\u5185\u67E5\u627E\u5B57\u7B26",helpMatchingBracket:"\u8DF3\u8F6C\u5230\u5339\u914D\u62EC\u53F7",helpPageMovement:"\u7FFB\u9875",helpHalfPageMovement:"\u534A\u9875",helpDeleteChar:"\u5220\u9664\u5B57\u7B26",helpDelete:"\u5220\u9664",helpChange:"\u4FEE\u6539",helpYank:"\u590D\u5236",helpPaste:"\u7C98\u8D34",helpUndoRedo:"\u64A4\u9500/\u91CD\u505A",helpRepeatEdit:"\u91CD\u590D\u4E0A\u6B21\u7F16\u8F91",helpToggleCase:"\u5207\u6362\u5927\u5C0F\u5199",helpJoinLines:"\u5408\u5E76\u884C",helpIndent:"\u7F29\u8FDB",helpDeleteWord:"\u5220\u9664\u5355\u8BCD",helpDeleteInQuotes:'\u5220\u9664"..."\u5185\u5BB9',helpDeleteInParens:"\u5220\u9664(...)\u5185\u5BB9",helpDeleteInBrackets:"\u5220\u9664[...]\u5185\u5BB9",helpDeleteInBraces:"\u5220\u9664{...}\u5185\u5BB9",helpSetMark:"\u8BBE\u7F6E\u6807\u8BB0",helpGoToMark:"\u8DF3\u8F6C\u5230\u6807\u8BB0",helpRecordMacro:"\u5F55\u5236\u5B8F",helpPlayMacro:"\u64AD\u653E\u5B8F",helpForwardSearch:"\u5411\u524D\u641C\u7D22",helpNextPrev:"\u4E0B\u4E00\u4E2A/\u4E0A\u4E00\u4E2A\u5339\u914D",helpSearchWord:"\u641C\u7D22\u5149\u6807\u4E0B\u7684\u5355\u8BCD",helpReplaceLine:"\u66FF\u6362\uFF08\u5F53\u524D\u884C\uFF09",helpReplaceAll:"\u5168\u90E8\u66FF\u6362",helpSave:"\u4FDD\u5B58",helpOpen:"\u6253\u5F00\u6587\u4EF6",helpNew:"\u65B0\u5EFA\u6587\u4EF6",helpQuit:"\u9000\u51FA",helpHelp:"\u663E\u793A\u5E2E\u52A9",helpInlineMath:"\u884C\u5185\u516C\u5F0F",helpBlockMath:"\u5757\u7EA7\u516C\u5F0F",helpMermaid:"Mermaid\u56FE\u8868",helpDetails:"\u53EF\u6298\u53E0",language:"\u8BED\u8A00"},es:{appTitle:"mdvim - Editor Markdown estilo Vim",edit:"Editar",preview:"Vista previa",split:"Dividir",fontSmaller:"Reducir fuente",fontLarger:"Aumentar fuente",toc:"\xCDndice",closeToc:"Cerrar \xEDndice",openToc:"Abrir \xEDndice",vimModeToggle:"Alternar modo VIM/Edici\xF3n",foldAll:"\u25B6 Plegar todo",unfoldAll:"\u25BC Desplegar todo",untitled:"Sin t\xEDtulo",helpHint:":help para mostrar ayuda",modified:"[Modificado]",saved:"Guardado",opened:"Abierto",newFile:"Nuevo archivo",undone:"Deshecho",redone:"Rehecho",noMoreUndo:"Nada que deshacer",noMoreRedo:"Nada que rehacer",yanked:"Copiado",notFound:"No encontrado",replaced:"Reemplazado",macroRecording:"Grabando @",macroSaved:"Macro guardada: @",macroPlayed:"Macro reproducida",markSet:"Marca '%s' establecida",helpTitle:"\u2328\uFE0F Ayuda de atajos",helpModeSwitch:"Cambio de modo",helpMovement:"Movimiento",helpEditing:"Edici\xF3n",helpTextObjects:"Objetos de texto",helpMarksAndMacros:"Marcas y Macros",helpSearchReplace:"Buscar y Reemplazar",helpCommands:"Comandos",helpMarkdown:"Markdown",helpClose:"Cerrar (Esc)",helpInsertAtCursor:"Insertar (en cursor)",helpInsertAtLineStart:"Insertar (inicio de l\xEDnea)",helpInsertAfterCursor:"Insertar (despu\xE9s del cursor)",helpInsertAtLineEnd:"Insertar (fin de l\xEDnea)",helpInsertLineBelow:"Insertar l\xEDnea abajo",helpInsertLineAbove:"Insertar l\xEDnea arriba",helpVisualMode:"Modo visual",helpVisualLineMode:"Modo visual de l\xEDnea",helpToNormal:"A modo normal",helpCommandMode:"Modo comando",helpLeftDownUpRight:"Izquierda/Abajo/Arriba/Derecha",helpWordMovement:"Palabra (siguiente/anterior)",helpWordEnd:"Fin de palabra",helpLineStartEnd:"Inicio/Fin de l\xEDnea",helpFirstNonBlank:"Primer no-blanco",helpFileStartEnd:"Inicio/Fin de archivo",helpFindChar:"Buscar car\xE1cter en l\xEDnea",helpMatchingBracket:"Par\xE9ntesis coincidente",helpPageMovement:"Movimiento por p\xE1gina",helpHalfPageMovement:"Media p\xE1gina",helpDeleteChar:"Eliminar car\xE1cter",helpDelete:"Eliminar",helpChange:"Cambiar",helpYank:"Copiar",helpPaste:"Pegar",helpUndoRedo:"Deshacer/Rehacer",helpRepeatEdit:"Repetir \xFAltima edici\xF3n",helpToggleCase:"Alternar may\xFAsculas",helpJoinLines:"Unir l\xEDneas",helpIndent:"Indentar",helpDeleteWord:"Eliminar palabra",helpDeleteInQuotes:'Eliminar en "..."',helpDeleteInParens:"Eliminar en (...)",helpDeleteInBrackets:"Eliminar en [...]",helpDeleteInBraces:"Eliminar en {...}",helpSetMark:"Establecer marca",helpGoToMark:"Ir a marca",helpRecordMacro:"Grabar macro",helpPlayMacro:"Reproducir macro",helpForwardSearch:"Buscar hacia adelante",helpNextPrev:"Siguiente/Anterior resultado",helpSearchWord:"Buscar palabra bajo cursor",helpReplaceLine:"Reemplazar (l\xEDnea actual)",helpReplaceAll:"Reemplazar todo",helpSave:"Guardar",helpOpen:"Abrir archivo",helpNew:"Nuevo archivo",helpQuit:"Salir",helpHelp:"Mostrar ayuda",helpInlineMath:"F\xF3rmula en l\xEDnea",helpBlockMath:"F\xF3rmula en bloque",helpMermaid:"Diagrama Mermaid",helpDetails:"Plegable",language:"Idioma"}};function Tt(){let s=navigator.language;if(s in ce)return s;let e=s.split("-")[0];return e==="zh"?"zh-CN":{en:"en",ja:"ja",ko:"ko",es:"es"}[e]||"en"}var te=class{elements;mode="normal";vimMode=!0;wrapEnabled=!1;modified=!1;currentFileName="\u7121\u984C";currentFileHandle=null;documentMetadata={title:"",author:"",language:"ja"};uploadedImages=new Map;registers={};marks={};macros={};undoStack=[];redoStack=[];count="";pendingKey="";pendingOperator="";visualStart=null;visualLine=!1;selectedRegister='"';searchTerm="";searchBackward=!1;recordingMacro=null;macroBuffer=[];lastMacro=null;lastFindChar=null;lastFindDirection=1;lastFindType="f";lastCommand=null;insertStartPos=0;insertCommand="";fontSize=100;autoSaveInterval="1s";autoSaveTimer=null;currentLanguage="en";t=ce.en;commandHistory=new le;previousPosition=null;measureSpan=null;cursorUpdateScheduled=!1;isScrollSyncing=!1;constructor(){this.initElements(),this.loadSettings(),this.setupEventListeners(),this.loadFromStorage(),this.registerCommands(),this.startAutoSave(),this.updateLineNumbers(),this.updatePreview(),this.updateCursorOverlay()}initElements(){this.elements={editor:L("editor"),preview:L("preview-content"),lineNumbers:L("line-numbers"),modeIndicator:L("vim-mode"),cursorPos:L("cursor-pos"),commandLine:L("command-line"),commandInput:L("command-input"),commandPrefix:L("command-prefix"),fileStatus:L("file-status"),fileName:L("file-name"),macroIndicator:L("macro-indicator"),cursorOverlay:L("cursor-overlay"),fileInput:L("file-input"),fontSizeDisplay:L("font-size-display"),tocPane:L("toc-pane"),tocContent:L("toc-content"),tocOpenBtn:L("toc-open-btn")},this.measureSpan=document.createElement("span"),this.measureSpan.style.cssText=`
      position: absolute;
      visibility: hidden;
      white-space: pre;
      pointer-events: none;
    `,document.body.appendChild(this.measureSpan)}loadSettings(){let e=F.loadSettings();this.fontSize=e.fontSize,this.vimMode=e.vimMode,this.autoSaveInterval=e.autoSaveInterval;let t=localStorage.getItem("mdvim-language");this.currentLanguage=t||Tt(),this.t=ce[this.currentLanguage],this.updateUIText(),this.applyFontSize(),this.updateVimModeButton(),this.vimMode?(this.mode="normal",this.elements.modeIndicator.textContent="NORMAL",this.elements.modeIndicator.className="",this.elements.editor.classList.remove("insert-mode")):(this.mode="insert",this.elements.modeIndicator.textContent="EDIT",this.elements.modeIndicator.className="edit-mode",this.elements.editor.classList.add("insert-mode")),document.body.setAttribute("data-theme",e.theme)}setupEventListeners(){let e=this.elements.editor;e.addEventListener("keydown",n=>this.handleKeydown(n)),e.addEventListener("input",()=>this.onInput()),e.addEventListener("click",()=>{this.updateCursorPos(),this.updateCursorOverlay()}),e.addEventListener("scroll",()=>this.syncScroll()),e.addEventListener("compositionstart",n=>this.handleCompositionStart(n)),e.addEventListener("compositionend",n=>this.handleCompositionEnd(n)),document.addEventListener("selectionchange",()=>{document.activeElement===e&&(this.updateCursorPos(),this.updateCursorOverlay())}),this.elements.preview.addEventListener("click",()=>{e.focus()}),this.elements.tocPane.addEventListener("click",n=>{n.target.classList.contains("toc-entry")||e.focus()}),this.elements.commandInput.addEventListener("keydown",n=>this.handleCommandKey(n)),document.addEventListener("keydown",n=>{if(n.key==="Escape"){let i=document.getElementById("help-modal");i&&!i.classList.contains("hidden")&&i.classList.add("hidden")}n.ctrlKey&&n.shiftKey&&n.key==="V"&&(n.preventDefault(),this.toggleVimMode()),n.ctrlKey&&n.code==="Backquote"&&(n.preventDefault(),this.toggleVimMode()),n.key==="F2"&&(n.preventDefault(),this.toggleVimMode()),n.ctrlKey&&n.key.toLowerCase()==="s"&&(n.preventDefault(),this.saveCurrentFile()),n.ctrlKey&&n.key.toLowerCase()==="o"&&(n.preventDefault(),this.openFileDialog()),n.ctrlKey&&n.key.toLowerCase()==="n"&&(n.preventDefault(),this.newFile())}),e.addEventListener("scroll",()=>{this.elements.lineNumbers.scrollTop=e.scrollTop,this.updateCursorOverlay(),this.syncScrollToPreview()}),this.elements.preview.addEventListener("scroll",()=>{this.syncScrollToEditor()}),e.addEventListener("paste",async n=>{let i=n.clipboardData;if(!i)return;let o=i.items;for(let a of o)if(a.type.startsWith("image/")){n.preventDefault();let l=a.getAsFile();l&&await this.handleImageFile(l);return}let r=i.getData("text");if(r&&r.includes("\r")){n.preventDefault();let a=M(r),l=e.selectionStart,c=e.selectionEnd,d=e.value.substring(0,l),h=e.value.substring(c);e.value=d+a+h;let m=l+a.length;S(e,m),this.modified=!0,this.updateFileStatus(),this.updatePreview(),this.updateLineNumbers()}}),this.elements.fileInput.addEventListener("change",n=>this.handleFileOpen(n)),this.setupDragDrop(),new ResizeObserver(()=>{this.wrapEnabled&&this.updateLineNumbers()}).observe(e)}setupDragDrop(){let e=document.body;e.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation(),e.classList.add("drag-over")}),e.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("drag-over")}),e.addEventListener("drop",async t=>{if(t.preventDefault(),t.stopPropagation(),e.classList.remove("drag-over"),!t.dataTransfer)return;let n=t.dataTransfer.files;for(let i of n){if(i.type.startsWith("image/")){await this.handleImageFile(i);continue}if(i.name.endsWith(".mdvim")){await this.loadMdvimFile(i);continue}if(i.name.endsWith(".docx")){await this.importFromDocx(i);continue}if(i.name.endsWith(".html")||i.name.endsWith(".htm")){await this.importFromHtmlFile(i);continue}let o=await Se(t.dataTransfer);o&&(this.uploadedImages.clear(),this.elements.editor.value=o.content,this.currentFileName=o.name,this.elements.fileName.textContent=o.name,this.currentFileHandle=o.handle||null,this.modified=!1,this.updateFileStatus(),this.updateLineNumbers(),this.updatePreview(),this.updateToc(),this.showStatus(`${o.name} - ${this.t.opened}`),this.elements.editor.focus())}})}async importFromDocx(e){try{if(typeof mammoth>"u"){this.showStatus("mammoth library not loaded",!0);return}this.showStatus("Importing DOCX...");let t=await e.arrayBuffer(),n=new Map,i=0,o=await mammoth.convertToHtml({arrayBuffer:t},{convertImage:mammoth.images.imgElement(async l=>{let c=await l.read("base64"),d=l.contentType.split("/")[1]||"png",h=`docx_img_${++i}.${d}`,m=`data:${l.contentType};base64,${c}`;return n.set(h,m),{src:`images/${h}`}})}),r=this.htmlToMarkdown(o.value);this.uploadedImages.clear(),n.forEach((l,c)=>{this.uploadedImages.set(c,l)}),this.elements.editor.value=r,this.currentFileName=e.name.replace(/\.docx$/i,".md"),this.elements.fileName.textContent=this.currentFileName,this.currentFileHandle=null,this.modified=!0,this.updateFileStatus(),this.updateLineNumbers(),this.updatePreview(),this.updateToc();let a=n.size>0?` (${n.size} images)`:"";this.showStatus(`Imported: ${e.name}${a}`)}catch(t){this.showStatus("DOCX import failed",!0),console.error(t)}}async importFromHtmlFile(e){try{let t=await e.text();await this.importFromHtml(t,e.name)}catch(t){this.showStatus("HTML import failed",!0),console.error(t)}}async importFromHtml(e,t){try{if(typeof TurndownService>"u"){this.showStatus("Turndown library not loaded",!0);return}let i=new DOMParser().parseFromString(e,"text/html"),o=i.querySelectorAll("img"),r=0;this.uploadedImages.clear(),o.forEach(c=>{let d=c.getAttribute("src");if(d&&d.startsWith("data:image/")){let h=d.match(/^data:image\/(\w+);base64,/);if(h){let m=h[1],p=`html_img_${++r}.${m}`;this.uploadedImages.set(p,d),c.setAttribute("src",`images/${p}`)}}});let a=this.htmlToMarkdown(i.body.innerHTML);this.elements.editor.value=a,t&&(this.currentFileName=t.replace(/\.html?$/i,".md"),this.elements.fileName.textContent=this.currentFileName),this.currentFileHandle=null,this.modified=!0,this.updateFileStatus(),this.updateLineNumbers(),this.updatePreview(),this.updateToc();let l=this.uploadedImages.size>0?` (${this.uploadedImages.size} images)`:"";this.showStatus(`Imported HTML${l}`)}catch(n){this.showStatus("HTML import failed",!0),console.error(n)}}htmlToMarkdown(e){let t=new TurndownService({headingStyle:"atx",codeBlockStyle:"fenced",fence:"```",bulletListMarker:"-",strongDelimiter:"**",emDelimiter:"*"});return t.addRule("table",{filter:"table",replacement:function(n,i){let o=i,r=[];if(o.querySelectorAll("tr").forEach(c=>{let d=[];c.querySelectorAll("th, td").forEach(h=>{d.push(h.textContent?.trim()||"")}),d.length>0&&r.push(d)}),r.length===0)return"";let a=Math.max(...r.map(c=>c.length)),l=`
`;l+="| "+r[0].map(c=>c||" ").join(" | ")+` |
`,l+="| "+Array(a).fill("---").join(" | ")+` |
`;for(let c=1;c<r.length;c++)l+="| "+r[c].map(d=>d||" ").join(" | ")+` |
`;return l+`
`}}),t.addRule("pre",{filter:"pre",replacement:function(n,i){let o=i.querySelector("code"),r=o?.className.match(/language-(\w+)/)?.[1]||"",a=o?.textContent||i.textContent||"";return"\n```"+r+`
`+a.trim()+"\n```\n"}}),t.turndown(e).trim()}async importFromUrl(e){try{this.showStatus("Fetching URL...");let t=`https://api.allorigins.win/raw?url=${encodeURIComponent(e)}`,n=await fetch(t);if(!n.ok)throw new Error(`HTTP ${n.status}`);let i=n.headers.get("content-type")||"",o=await n.text();i.includes("text/html")||o.trim().startsWith("<!")||o.trim().startsWith("<html")?await this.importFromHtml(o,e):i.includes("text/markdown")||e.endsWith(".md")?(this.uploadedImages.clear(),this.elements.editor.value=o,this.currentFileName=e.split("/").pop()||"imported.md",this.elements.fileName.textContent=this.currentFileName,this.currentFileHandle=null,this.modified=!0,this.updateFileStatus(),this.updateLineNumbers(),this.updatePreview(),this.updateToc(),this.showStatus(`Imported: ${this.currentFileName}`)):(this.uploadedImages.clear(),this.elements.editor.value=o,this.currentFileName="imported.md",this.elements.fileName.textContent=this.currentFileName,this.modified=!0,this.updateFileStatus(),this.updateLineNumbers(),this.updatePreview(),this.updateToc(),this.showStatus("Imported as plain text"))}catch(t){this.showStatus(`Import failed: ${t}`,!0),console.error(t)}}async importFromClipboard(){try{let e=await navigator.clipboard.read();for(let t of e)if(t.types.includes("text/html")){let i=await(await t.getType("text/html")).text();await this.importFromHtml(i,"clipboard");return}this.showStatus("No HTML in clipboard",!0)}catch(e){this.showStatus("Clipboard access denied",!0),console.error(e)}}openImportDialog(){let e=document.createElement("input");e.type="file",e.accept=".docx,.html,.htm",e.onchange=async t=>{let n=t.target.files?.[0];n&&(n.name.endsWith(".docx")?await this.importFromDocx(n):(n.name.endsWith(".html")||n.name.endsWith(".htm"))&&await this.importFromHtmlFile(n))},e.click()}async handleImageFile(e){return new Promise(t=>{let n=new FileReader;n.onload=i=>{let o=i.target?.result,r=this.generateImageName(e.name);this.uploadedImages.set(r,o);let a=this.elements.editor,l=a.selectionStart,c=a.value.substring(0,l),d=a.value.substring(l),h=`![${e.name}](images/${r})`;a.value=c+h+d;let m=l+h.length;S(a,m),this.modified=!0,this.updateFileStatus(),this.updatePreview(),this.updateLineNumbers(),this.showStatus(`Image added: ${r}`),t()},n.readAsDataURL(e)})}generateImageName(e){let t=e.split(".").pop()?.toLowerCase()||"png",n=e.replace(/\.[^.]+$/,"").replace(/[^a-zA-Z0-9_-]/g,"_"),i=`${n}.${t}`,o=1;for(;this.uploadedImages.has(i);)i=`${n}_${o}.${t}`,o++;return i}registerCommands(){let e={editor:this.elements.editor,saveState:()=>this.saveState(),updatePreview:()=>this.updatePreview(),gotoLine:t=>this.gotoLine(t),showStatus:(t,n)=>this.showStatus(t,n),openFile:()=>this.openFileDialog(),saveFile:()=>this.saveCurrentFile(),newFile:()=>this.newFile(),editFile:(t,n)=>this.editFile(t,n),isModified:()=>this.modified,setTheme:t=>this.setTheme(t),setVimMode:t=>this.setVimModeEnabled(t),setWrap:t=>this.setWrapEnabled(t),quit:()=>this.quit(),exportAs:t=>this.exportAs(t),getImageCount:()=>this.uploadedImages.size,importFromUrl:t=>this.importFromUrl(t),importFromClipboard:()=>this.importFromClipboard(),openImportDialog:()=>this.openImportDialog()};ze(e)}loadFromStorage(){let e=F.loadSession();e?(this.elements.editor.value=e.content,this.currentFileName=e.filename,this.elements.fileName.textContent=e.filename,this.showStatus("\u30BB\u30C3\u30B7\u30E7\u30F3\u3092\u5FA9\u5143\u3057\u307E\u3057\u305F")):this.elements.editor.value=this.getWelcomeContent()}getWelcomeContent(){return`# Welcome to mdvim!

Edit Markdown with Vim-style keybindings.

## Quick Start

- \`:help\` to show help
- \`:w\` to save
- \`:e\` to open file

## Features

- Real-time preview
- Syntax highlighting
- KaTeX math support
- Mermaid diagram support

Give it a try!
`}startAutoSave(){if(this.autoSaveTimer&&clearInterval(this.autoSaveTimer),this.autoSaveInterval==="off")return;let t={off:0,"1s":1e3,"5s":5e3,"10s":1e4,"30s":3e4,"60s":6e4}[this.autoSaveInterval];t>0&&(this.autoSaveTimer=setInterval(()=>{this.saveSessionData()},t))}saveSessionData(){F.saveSession(this.elements.editor.value,this.currentFileName)}handleKeydown(e){if(!this.vimMode){e.key==="Escape"&&this.enterNormalMode();return}switch(this.recordingMacro&&e.key!=="q"&&this.macroBuffer.push({key:e.key,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey}),this.mode){case"normal":this.handleNormalMode(e);break;case"insert":this.handleInsertMode(e);break;case"visual":this.handleVisualMode(e);break;case"command":break}this.updateCursorPos(),this.updateCursorOverlay()}shouldAllowIME(){return this.mode==="insert"||this.mode==="command"||!this.vimMode||this.pendingKey==="f"||this.pendingKey==="F"||this.pendingKey==="t"||this.pendingKey==="T"||this.pendingKey==="r"||this.pendingKey==="R"}handleCompositionStart(e){}handleCompositionEnd(e){let t=this.elements.editor,n=e.data;if(!n||n.length===0)return;if(!this.shouldAllowIME()){let o=t.selectionStart;t.value=t.value.substring(0,o-n.length)+t.value.substring(o),t.selectionStart=o-n.length,t.selectionEnd=o-n.length,this.updateCursorOverlay();return}let i=n[0];if(this.pendingKey==="f"||this.pendingKey==="F"||this.pendingKey==="t"||this.pendingKey==="T"){let o=this.getCount(),r=this.pendingKey==="f"||this.pendingKey==="t"?1:-1,a=this.pendingKey==="t"||this.pendingKey==="T",l=t.selectionStart;t.value=t.value.substring(0,l-n.length)+t.value.substring(l),t.selectionStart=l-n.length,t.selectionEnd=l-n.length,Y(t,i,r,a,o)&&(this.lastFindChar=i,this.lastFindDirection=r,this.lastFindType=a?"t":"f"),this.pendingKey="",this.count="",this.updateCursorPos(),this.updateCursorOverlay(),this.updatePreview();return}if(this.pendingKey==="r"){let r=t.selectionStart-n.length;if(r>=0&&r<t.value.length){let a=t.value.substring(0,r),l=t.value.substring(r+1+n.length-1);t.value=a+i+l,t.selectionStart=r+1,t.selectionEnd=r+1}this.pendingKey="",this.count="",this.updateCursorPos(),this.updateCursorOverlay(),this.updatePreview();return}}handleNormalMode(e){let t=e.key,n=this.elements.editor;if(e.ctrlKey)switch(t){case"r":e.preventDefault(),this.redoAction();return;case"f":e.preventDefault(),this.pageDown();return;case"b":e.preventDefault(),this.pageUp();return;case"d":e.preventDefault(),this.halfPageDown();return;case"u":e.preventDefault(),this.halfPageUp();return;case"[":e.preventDefault(),this.enterNormalMode();return}if((/^[1-9]$/.test(t)||this.count&&t==="0")&&!(this.pendingKey==="f"||this.pendingKey==="F"||this.pendingKey==="t"||this.pendingKey==="T"||this.pendingKey==="r"||this.pendingKey==="R")){this.count+=t,e.preventDefault();return}if(this.pendingOperator){this.handlePendingOperator(e);return}if(this.pendingKey==='"'){this.selectedRegister=t,this.pendingKey="",e.preventDefault();return}if(this.pendingKey==="m"){/[a-zA-Z]/.test(t)&&(this.marks[t]=n.selectionStart,this.showStatus(this.t.markSet.replace("%s",t))),this.pendingKey="",e.preventDefault();return}if(this.pendingKey==="'"||this.pendingKey==="`"){if(t==="'"){if(this.previousPosition!==null){let o=n.selectionStart;S(n,this.previousPosition),this.previousPosition=o}}else this.marks[t]!==void 0&&(this.previousPosition=n.selectionStart,S(n,this.marks[t]),this.pendingKey==="'"&&D(n));this.pendingKey="",e.preventDefault();return}if(this.pendingKey==="f"||this.pendingKey==="F"||this.pendingKey==="t"||this.pendingKey==="T"){if(t==="Shift"||t==="Control"||t==="Alt"||t==="Meta")return;let o=this.getCount(),r=this.pendingKey==="f"||this.pendingKey==="t"?1:-1,a=this.pendingKey==="t"||this.pendingKey==="T";Y(n,t,r,a,o)&&(this.lastFindChar=t,this.lastFindDirection=r,this.lastFindType=a?"t":"f"),this.pendingKey="",this.count="",e.preventDefault();return}if(this.pendingKey==="r"){if(t==="Shift"||t==="Control"||t==="Alt"||t==="Meta")return;if(t.length===1){this.saveState();let o=n.selectionStart,r=this.getCount();for(let a=0;a<r&&o+a<n.value.length;a++)n.value=n.value.substring(0,o+a)+t+n.value.substring(o+a+1);S(n,o),this.lastCommand={type:"replace",char:t,count:r},this.updatePreview()}this.pendingKey="",this.count="",e.preventDefault();return}if(this.pendingKey==="q"){/[a-zA-Z]/.test(t)&&(this.recordingMacro?this.stopMacroRecording():this.startMacroRecording(t)),this.pendingKey="",e.preventDefault();return}if(this.pendingKey==="@"){t==="@"&&this.lastMacro?this.playMacro(this.lastMacro):/[a-zA-Z]/.test(t)&&this.macros[t]&&(this.playMacro(t),this.lastMacro=t),this.pendingKey="",e.preventDefault();return}e.preventDefault();let i=this.getCount();if(this.pendingKey==="g"){switch(t){case"g":Me(n);break;case"e":$e(n,i);break;case"j":this.moveDisplayLine(1,i);break;case"k":this.moveDisplayLine(-1,i);break}this.pendingKey="",this.count="";return}if(this.pendingKey==="z"){switch(t){case"z":case".":this.scrollCursorToCenter();break;case"t":case"Enter":this.scrollCursorToTop();break;case"b":case"-":this.scrollCursorToBottom();break}this.pendingKey="",this.count="";return}switch(t){case"h":G(n,i);break;case"j":se(n,i);break;case"k":ie(n,i);break;case"l":z(n,i);break;case"ArrowLeft":G(n,i);break;case"ArrowDown":se(n,i);break;case"ArrowUp":ie(n,i);break;case"ArrowRight":z(n,i);break;case"w":ye(n,i);break;case"b":we(n,i);break;case"e":Oe(n,i);break;case"0":Q(n);break;case"$":W(n);break;case"^":D(n);break;case"G":this.count?Te(n,parseInt(this.count)):Le(n);break;case"%":Be(n);break;case"H":this.moveToScreenTop();break;case"M":this.moveToScreenMiddle();break;case"L":this.moveToScreenBottom();break;case"i":this.enterInsertMode("i");break;case"I":D(n),this.enterInsertMode("I");break;case"a":z(n),this.enterInsertMode("a");break;case"A":W(n),this.enterInsertMode("A");break;case"o":this.insertLineBelow();break;case"O":this.insertLineAbove();break;case"x":this.deleteChar(i);break;case"X":this.deleteCharBefore(i);break;case"p":this.pasteAfter();break;case"P":this.pasteBefore();break;case"u":this.undoAction();break;case"J":this.saveState(),re(n,i),this.lastCommand={type:"other",command:"J",count:i},this.updatePreview();break;case"~":this.saveState(),ae(n,i),this.lastCommand={type:"other",command:"~",count:i},this.updatePreview();break;case".":this.repeatLastEdit();break;case"d":this.pendingOperator="d";break;case"y":this.pendingOperator="y";break;case"c":this.pendingOperator="c";break;case">":this.pendingOperator=">";break;case"<":this.pendingOperator="<";break;case"g":this.pendingKey="g";break;case"z":this.pendingKey="z";break;case'"':this.pendingKey='"';break;case"m":this.pendingKey="m";break;case"'":this.pendingKey="'";break;case"`":this.pendingKey="`";break;case"f":this.pendingKey="f";break;case"F":this.pendingKey="F";break;case"t":this.pendingKey="t";break;case"T":this.pendingKey="T";break;case"r":this.pendingKey="r";break;case"q":this.recordingMacro?this.stopMacroRecording():this.pendingKey="q";break;case"@":this.pendingKey="@";break;case"v":this.enterVisualMode();break;case"V":this.enterVisualLineMode();break;case"/":this.startSearch(!1);break;case"?":this.startSearch(!0);break;case"n":this.searchNext();break;case"N":this.searchPrev();break;case"*":this.searchWordUnderCursor();break;case":":this.enterCommandMode();break;case";":this.lastFindChar&&Y(n,this.lastFindChar,this.lastFindDirection,this.lastFindType==="t",i);break;case",":if(this.lastFindChar){let o=this.lastFindDirection===1?-1:1;Y(n,this.lastFindChar,o,this.lastFindType==="t",i)}break;case"{":this.moveParagraphUp(i);break;case"}":this.moveParagraphDown(i);break;case"D":this.saveState(),j(n),k(this.registers,"",'"',!0),this.lastCommand={type:"delete",command:"D",count:1},this.updatePreview();break;case"C":this.saveState(),j(n),this.enterInsertMode("C");break;case"Y":k(this.registers,oe(n,i),this.selectedRegister),this.showStatus(this.t.yanked);break;case"S":this.saveState(),this.clearLine(),this.enterInsertMode("S");break}this.count=""}scrollCursorToCenter(){let e=this.elements.editor,t=parseFloat(getComputedStyle(e).lineHeight),n=e.value,i=e.selectionStart,r=(n.substring(0,i).split(`
`).length-1)*t;e.scrollTop=r-e.clientHeight/2+t,this.updateCursorPos(),this.updateCursorOverlay()}scrollCursorToTop(){let e=this.elements.editor,t=parseFloat(getComputedStyle(e).lineHeight),n=e.value,i=e.selectionStart,r=(n.substring(0,i).split(`
`).length-1)*t;e.scrollTop=r,this.updateCursorPos(),this.updateCursorOverlay()}scrollCursorToBottom(){let e=this.elements.editor,t=parseFloat(getComputedStyle(e).lineHeight),n=e.value,i=e.selectionStart,r=(n.substring(0,i).split(`
`).length-1)*t;e.scrollTop=r-e.clientHeight+t*2,this.updateCursorPos(),this.updateCursorOverlay()}moveToScreenTop(){let e=this.elements.editor,t=parseFloat(getComputedStyle(e).lineHeight)||20,i=e.value.split(`
`),o=Math.floor(e.scrollTop/t),r=Math.min(o,i.length-1),a=0;for(let l=0;l<r;l++)a+=i[l].length+1;S(e,a),D(e)}moveToScreenMiddle(){let e=this.elements.editor,t=parseFloat(getComputedStyle(e).lineHeight)||20,i=e.value.split(`
`),o=Math.floor(e.scrollTop/t),r=Math.floor(e.clientHeight/t),a=Math.min(o+Math.floor(r/2),i.length-1),l=0;for(let c=0;c<a;c++)l+=i[c].length+1;S(e,l),D(e)}moveToScreenBottom(){let e=this.elements.editor,t=parseFloat(getComputedStyle(e).lineHeight)||20,i=e.value.split(`
`),o=Math.floor(e.scrollTop/t),r=Math.floor(e.clientHeight/t),a=Math.min(o+r-1,i.length-1),l=0;for(let c=0;c<a;c++)l+=i[c].length+1;S(e,l),D(e)}getCount(){return this.count?parseInt(this.count):1}showStatus(e,t=!1){let n=this.elements.fileStatus;n.textContent=e,n.style.color=t?"var(--accent-red)":"var(--accent-green)",setTimeout(()=>{n.textContent="",n.style.color=""},3e3)}saveState(){xe(this.elements.editor,this.undoStack),this.redoStack=[]}undoAction(){Ce(this.elements.editor,this.undoStack,this.redoStack)?(this.updatePreview(),this.updateLineNumbers(),this.showStatus(this.t.undone)):this.showStatus(this.t.noMoreUndo)}redoAction(){Ie(this.elements.editor,this.undoStack,this.redoStack)?(this.updatePreview(),this.updateLineNumbers(),this.showStatus(this.t.redone)):this.showStatus(this.t.noMoreRedo)}enterNormalMode(){if(this.mode==="insert"&&this.insertCommand){let e=this.elements.editor,t=e.selectionStart,n=e.value.substring(this.insertStartPos,t);(n.length>0||this.insertCommand==="o"||this.insertCommand==="O")&&(this.lastCommand={type:"insert",command:this.insertCommand,text:n,count:1})}this.mode="normal",this.visualStart=null,this.visualLine=!1,this.elements.modeIndicator.textContent="NORMAL",this.elements.modeIndicator.className="",this.elements.editor.classList.remove("insert-mode"),this.elements.cursorOverlay.classList.remove("insert","visual"),this.updateCursorOverlay()}enterInsertMode(e="i"){this.mode="insert",this.elements.modeIndicator.textContent="INSERT",this.elements.modeIndicator.className="insert",this.elements.editor.classList.add("insert-mode"),this.elements.cursorOverlay.classList.add("insert"),this.elements.cursorOverlay.classList.remove("visual"),this.insertStartPos=this.elements.editor.selectionStart,this.insertCommand=e}enterVisualMode(){this.mode="visual",this.visualStart=this.elements.editor.selectionStart,this.visualLine=!1,this.elements.modeIndicator.textContent="VISUAL",this.elements.modeIndicator.className="visual",this.elements.cursorOverlay.classList.add("visual")}enterVisualLineMode(){this.mode="visual",this.visualStart=this.elements.editor.selectionStart,this.visualLine=!0,this.elements.modeIndicator.textContent="V-LINE",this.elements.modeIndicator.className="visual",this.elements.cursorOverlay.classList.add("visual")}enterCommandMode(){this.mode="command",this.elements.commandLine.classList.remove("hidden"),this.elements.commandPrefix.textContent=":",this.elements.commandInput.value="",this.elements.commandInput.focus(),this.elements.modeIndicator.textContent="COMMAND",this.elements.modeIndicator.className="command"}handleInsertMode(e){if(e.key==="Escape"||e.ctrlKey&&e.key==="["){e.preventDefault(),this.enterNormalMode(),G(this.elements.editor);return}if(e.key==="Tab"){e.preventDefault();let t=this.elements.editor,n=t.selectionStart,i=t.selectionEnd;if(e.shiftKey)V(t);else{let o="  ";t.value=t.value.substring(0,n)+o+t.value.substring(i),t.selectionStart=t.selectionEnd=n+o.length}this.updateLineNumbers();return}}handleVisualMode(e){let t=this.elements.editor,n=e.key;if(n==="Escape"||e.ctrlKey&&n==="["){e.preventDefault(),this.enterNormalMode();return}e.preventDefault();let i=this.getCount();if(this.pendingKey==="g"){switch(n){case"g":Me(t);break;case"j":this.moveDisplayLine(1,i);break;case"k":this.moveDisplayLine(-1,i);break}if(this.pendingKey="",this.count="",this.visualStart!==null){let r=t.selectionStart,a=Math.min(this.visualStart,r),l=Math.max(this.visualStart,r);t.setSelectionRange(a,l+1)}return}let o=t.selectionEnd;switch(this.visualStart!==null&&t.selectionStart<this.visualStart&&(o=t.selectionStart),this.visualStart!==null&&o>this.visualStart&&(o=t.selectionEnd-1),t.selectionStart=o,t.selectionEnd=o,n){case"h":case"ArrowLeft":G(t,i);break;case"j":case"ArrowDown":se(t,i);break;case"k":case"ArrowUp":ie(t,i);break;case"l":case"ArrowRight":z(t,i);break;case"w":ye(t,i);break;case"b":we(t,i);break;case"0":Q(t);break;case"$":W(t);break;case"G":Le(t);break;case"g":this.pendingKey="g",this.count="";return;case"d":case"x":if(this.visualStart!==null){let r=Math.min(this.visualStart,o),a=Math.max(this.visualStart,o);t.setSelectionRange(r,a+1)}this.saveState(),this.deleteVisualSelection(),this.enterNormalMode(),this.count="";return;case"y":if(this.visualStart!==null){let r=Math.min(this.visualStart,o),a=Math.max(this.visualStart,o);t.setSelectionRange(r,a+1)}this.yankVisualSelection(),this.enterNormalMode(),this.count="";return;case"c":if(this.visualStart!==null){let r=Math.min(this.visualStart,o),a=Math.max(this.visualStart,o);t.setSelectionRange(r,a+1)}this.saveState(),this.deleteVisualSelection(),this.enterInsertMode("c"),this.count="";return;case">":if(this.visualStart!==null){let r=Math.min(this.visualStart,o),a=Math.max(this.visualStart,o);t.setSelectionRange(r,a+1)}this.saveState(),this.indentVisualSelection(),this.enterNormalMode(),this.count="";return;case"<":if(this.visualStart!==null){let r=Math.min(this.visualStart,o),a=Math.max(this.visualStart,o);t.setSelectionRange(r,a+1)}this.saveState(),this.dedentVisualSelection(),this.enterNormalMode(),this.count="";return}if(this.visualStart!==null){let r=t.selectionStart,a=Math.min(this.visualStart,r),l=Math.max(this.visualStart,r);t.setSelectionRange(a,l+1)}this.count=""}handlePendingOperator(e){let t=e.key,n=this.elements.editor,i=this.pendingOperator,o=this.getCount();if(e.preventDefault(),t===i){switch(this.saveState(),i){case"d":k(this.registers,U(n,o),this.selectedRegister,!0),this.lastCommand={type:"delete",command:"dd",count:o};break;case"y":k(this.registers,oe(n,o),this.selectedRegister),this.showStatus(this.t.yanked);break;case"c":U(n,o),this.enterInsertMode("cc");break;case">":for(let r=0;r<o;r++)ee(n);this.lastCommand={type:"other",command:">>",count:o};break;case"<":for(let r=0;r<o;r++)V(n);this.lastCommand={type:"other",command:"<<",count:o};break}this.updatePreview(),this.updateLineNumbers(),this.pendingOperator="",this.count="",this.selectedRegister='"';return}if(t==="w"){this.saveState();let r=Z(n,!0);i==="d"||i==="c"?(k(this.registers,r,this.selectedRegister,i==="d"),i==="d"&&(this.lastCommand={type:"delete",command:"dw",count:o})):i==="y"&&(k(this.registers,r,this.selectedRegister),this.showStatus(this.t.yanked)),i==="c"&&this.enterInsertMode("cw"),this.updatePreview()}if(t==="i"||t==="a"){this.pendingKey=t;return}if(this.pendingKey==="i"||this.pendingKey==="a"){let r=this.pendingKey==="i";this.handleTextObject(i,t,r),this.pendingKey=""}this.pendingOperator="",this.count="",this.selectedRegister='"'}handleTextObject(e,t,n){let i=this.elements.editor,o=i.value,r=i.selectionStart,a=-1,l=-1;if(t==="w"){for(a=r,l=r;a>0&&/\w/.test(o[a-1]);)a--;for(;l<o.length&&/\w/.test(o[l]);)l++;if(!n)for(;l<o.length&&/\s/.test(o[l]);)l++}let c={"(":["(",")"],")":["(",")"],"[":["[","]"],"]":["[","]"],"{":["{","}"],"}":["{","}"],"<":["<",">"],">":["<",">"],'"':['"','"'],"'":["'","'"],"`":["`","`"]};if(c[t]){let[d,h]=c[t],m=0;for(let p=r;p>=0;p--)if(o[p]===h&&p!==r&&m++,o[p]===d){if(m===0){a=p;break}m--}m=0;for(let p=r;p<o.length;p++)if(o[p]===d&&p!==r&&m++,o[p]===h){if(m===0){l=p+1;break}m--}n&&a!==-1&&l!==-1&&(a++,l--)}if(a!==-1&&l!==-1&&a<l){this.saveState();let d=o.substring(a,l);e==="d"||e==="c"?(i.value=o.substring(0,a)+o.substring(l),S(i,a),k(this.registers,d,this.selectedRegister,e==="d")):e==="y"&&(k(this.registers,d,this.selectedRegister),this.showStatus(this.t.yanked)),e==="c"&&this.enterInsertMode("c"+(n?"i":"a")+t),this.updatePreview(),this.updateLineNumbers()}}deleteChar(e){let t=this.elements.editor;this.saveState();let n=K(t,t.selectionStart,t.selectionStart+e);k(this.registers,n,this.selectedRegister,!0),this.lastCommand={type:"delete",command:"x",count:e},this.updatePreview(),this.updateLineNumbers()}deleteCharBefore(e){let t=this.elements.editor,n=t.selectionStart;if(n===0)return;this.saveState();let i=Math.max(0,n-e),o=K(t,i,n);k(this.registers,o,this.selectedRegister,!0),this.lastCommand={type:"delete",command:"X",count:e},this.updatePreview(),this.updateLineNumbers()}insertLineBelow(){let e=this.elements.editor;this.saveState(),W(e),x(e,`
`),this.enterInsertMode("o"),this.updateLineNumbers()}insertLineAbove(){let e=this.elements.editor;this.saveState(),Q(e);let t=e.selectionStart;e.value=e.value.substring(0,t)+`
`+e.value.substring(t),S(e,t),this.enterInsertMode("O"),this.updateLineNumbers()}clearLine(){let e=this.elements.editor,t=e.value,n=e.selectionStart,i=t.lastIndexOf(`
`,n-1)+1,o=t.indexOf(`
`,n);o===-1&&(o=t.length),e.value=t.substring(0,i)+t.substring(o),S(e,i)}async pasteAfter(){let e=this.selectedRegister;this.selectedRegister='"';let t;if((e==="*"||e==="+")&&navigator.clipboard)try{t=await navigator.clipboard.readText(),this.registers["*"]=t,this.registers["+"]=t}catch{t=_(this.registers,e)}else t=_(this.registers,e);t&&(t=M(t),this.saveState(),ke(this.elements.editor,t),this.updatePreview(),this.updateLineNumbers())}async pasteBefore(){let e=this.selectedRegister;this.selectedRegister='"';let t;if((e==="*"||e==="+")&&navigator.clipboard)try{t=await navigator.clipboard.readText(),this.registers["*"]=t,this.registers["+"]=t}catch{t=_(this.registers,e)}else t=_(this.registers,e);t&&(t=M(t),this.saveState(),Ee(this.elements.editor,t),this.updatePreview(),this.updateLineNumbers())}repeatLastEdit(){if(!this.lastCommand)return;this.saveState();let e=this.elements.editor,t=this.lastCommand;switch(t.type){case"insert":switch(t.command){case"i":x(e,t.text);break;case"a":z(e),x(e,t.text);break;case"I":D(e),x(e,t.text);break;case"A":W(e),x(e,t.text);break;case"o":W(e),x(e,`
`+t.text);break;case"O":Q(e);let i=e.selectionStart;e.value=e.value.substring(0,i)+t.text+`
`+e.value.substring(i),S(e,i+t.text.length);break;case"C":j(e),x(e,t.text);break;case"S":this.clearLine(),x(e,t.text);break;case"cc":U(e,1),x(e,t.text);break;case"cw":Z(e,!0),x(e,t.text);break;default:t.command.startsWith("c")&&x(e,t.text);break}break;case"delete":for(let i=0;i<t.count;i++)switch(t.command){case"x":this.deleteCharInternal(1);break;case"X":this.deleteCharBeforeInternal(1);break;case"dd":U(e,1);break;case"dw":Z(e,!0);break;case"D":j(e);break}break;case"replace":let n=e.selectionStart;for(let i=0;i<t.count;i++)n+i<e.value.length&&(e.value=e.value.substring(0,n+i)+t.char+e.value.substring(n+i+1));S(e,n);break;case"other":for(let i=0;i<t.count;i++)switch(t.command){case"~":ae(e,1);break;case"J":re(e,1);break;case">>":ee(e);break;case"<<":V(e);break}break}this.updatePreview(),this.updateLineNumbers()}deleteCharInternal(e){let t=this.elements.editor,n=t.selectionStart,i=t.value,o=Math.min(e,i.length-n),r=i.substring(n,n+o);t.value=i.substring(0,n)+i.substring(n+o),S(t,n),k(this.registers,r,this.selectedRegister,!0)}deleteCharBeforeInternal(e){let t=this.elements.editor,n=t.selectionStart,i=t.value,o=Math.min(e,n),r=i.substring(n-o,n);t.value=i.substring(0,n-o)+i.substring(n),S(t,n-o),k(this.registers,r,this.selectedRegister,!0)}deleteVisualSelection(){let e=this.elements.editor,t=e.selectionStart,n=e.selectionEnd,i=e.value.substring(t,n);e.value=e.value.substring(0,t)+e.value.substring(n),S(e,t),k(this.registers,i,this.selectedRegister,!0),this.updatePreview(),this.updateLineNumbers()}yankVisualSelection(){let e=this.elements.editor,t=e.selectionStart,n=e.selectionEnd,i=e.value.substring(t,n);k(this.registers,i,this.selectedRegister),S(e,t),this.showStatus(this.t.yanked)}indentVisualSelection(){ee(this.elements.editor),this.updatePreview(),this.updateLineNumbers()}dedentVisualSelection(){V(this.elements.editor),this.updatePreview(),this.updateLineNumbers()}pageDown(){let e=this.elements.editor,t=parseInt(getComputedStyle(e).lineHeight),n=Math.floor(e.clientHeight/t),o=Math.max(1,n-2),r=e.value,a=e.selectionStart,c=r.substring(0,a).split(`
`).length-1,d=e.scrollTop,h=Math.floor(d/t),m=c-h,p=r.split(`
`).length,g=Math.min(c+o,p-1),u=r.split(`
`),v=0;for(let O=0;O<g;O++)v+=u[O].length+1;S(e,v);let w=(g-m)*t;e.scrollTop=Math.max(0,w)}pageUp(){let e=this.elements.editor,t=parseInt(getComputedStyle(e).lineHeight),n=Math.floor(e.clientHeight/t),o=Math.max(1,n-2),r=e.value,a=e.selectionStart,c=r.substring(0,a).split(`
`).length-1,d=e.scrollTop,h=Math.floor(d/t),m=c-h,p=Math.max(c-o,0),g=r.split(`
`),u=0;for(let w=0;w<p;w++)u+=g[w].length+1;S(e,u);let v=(p-m)*t;e.scrollTop=Math.max(0,v)}halfPageDown(){let e=this.elements.editor,t=parseInt(getComputedStyle(e).lineHeight),n=Math.floor(e.clientHeight/t),i=Math.max(1,Math.floor(n/2)),o=e.value,r=e.selectionStart,l=o.substring(0,r).split(`
`).length-1,c=e.scrollTop,d=Math.floor(c/t),h=l-d,m=o.split(`
`).length,p=Math.min(l+i,m-1),g=o.split(`
`),u=0;for(let w=0;w<p;w++)u+=g[w].length+1;S(e,u);let v=(p-h)*t;e.scrollTop=Math.max(0,v)}halfPageUp(){let e=this.elements.editor,t=parseInt(getComputedStyle(e).lineHeight),n=Math.floor(e.clientHeight/t),i=Math.max(1,Math.floor(n/2)),o=e.value,r=e.selectionStart,l=o.substring(0,r).split(`
`).length-1,c=e.scrollTop,d=Math.floor(c/t),h=l-d,m=Math.max(l-i,0),p=o.split(`
`),g=0;for(let v=0;v<m;v++)g+=p[v].length+1;S(e,g);let u=(m-h)*t;e.scrollTop=Math.max(0,u)}moveParagraphUp(e){let t=this.elements.editor,n=t.value,i=t.selectionStart;for(let o=0;o<e;o++){for(i--;i>0&&n[i]!==`
`;)i--;for(;i>0&&n[i]===`
`;)i--;for(;i>0&&n[i-1]!==`
`;)i--}S(t,Math.max(0,i))}moveParagraphDown(e){let t=this.elements.editor,n=t.value,i=t.selectionStart;for(let o=0;o<e;o++){for(;i<n.length&&n[i]!==`
`;)i++;for(;i<n.length&&n[i]===`
`;)i++}S(t,i)}startSearch(e=!1){this.searchBackward=e,this.enterCommandMode(),this.elements.commandPrefix.textContent=e?"?":"/"}searchNext(){if(!this.searchTerm)return;let e=this.elements.editor,t=e.value;if(this.searchBackward){let n=e.selectionStart,i=t.lastIndexOf(this.searchTerm,n-1);i===-1&&(i=t.lastIndexOf(this.searchTerm)),i!==-1?(S(e,i),this.showStatus(`?${this.searchTerm}`)):this.showStatus(this.t.notFound,!0)}else{let n=e.selectionStart+1,i=t.indexOf(this.searchTerm,n);i===-1&&(i=t.indexOf(this.searchTerm)),i!==-1?(S(e,i),this.showStatus(`/${this.searchTerm}`)):this.showStatus(this.t.notFound,!0)}}searchPrev(){if(!this.searchTerm)return;let e=this.elements.editor,t=e.value;if(this.searchBackward){let n=e.selectionStart+1,i=t.indexOf(this.searchTerm,n);i===-1&&(i=t.indexOf(this.searchTerm)),i!==-1?(S(e,i),this.showStatus(`?${this.searchTerm}`)):this.showStatus(this.t.notFound,!0)}else{let n=e.selectionStart,i=t.lastIndexOf(this.searchTerm,n-1);i===-1&&(i=t.lastIndexOf(this.searchTerm)),i!==-1?(S(e,i),this.showStatus(`/${this.searchTerm}`)):this.showStatus(this.t.notFound,!0)}}searchWordUnderCursor(){let e=this.elements.editor,t=e.value,n=e.selectionStart,i=n,o=n;for(;i>0&&/\w/.test(t[i-1]);)i--;for(;o<t.length&&/\w/.test(t[o]);)o++;let r=t.substring(i,o);r&&(this.searchTerm=r,this.searchNext())}handleCommandKey(e){if(e.key==="Escape"){this.exitCommandMode();return}if(e.key==="Enter"){e.preventDefault();let t=this.elements.commandInput.value;this.elements.commandPrefix.textContent==="/"?(this.searchTerm=t,this.searchNext()):this.executeCommandLine(t),this.commandHistory.add(t),this.exitCommandMode();return}if(e.key==="ArrowUp"){e.preventDefault();let t=this.commandHistory.previous();t!==void 0&&(this.elements.commandInput.value=t);return}if(e.key==="ArrowDown"){e.preventDefault();let t=this.commandHistory.next();t!==void 0&&(this.elements.commandInput.value=t);return}}exitCommandMode(){this.elements.commandLine.classList.add("hidden"),this.elements.commandInput.value="",this.elements.editor.focus(),this.enterNormalMode(),this.commandHistory.reset()}async executeCommandLine(e){let t={editor:this.elements.editor,saveState:()=>this.saveState(),updatePreview:()=>this.updatePreview(),gotoLine:i=>this.gotoLine(i),showStatus:(i,o)=>this.showStatus(i,o),openFile:()=>this.openFileDialog(),saveFile:()=>this.saveCurrentFile(),newFile:()=>this.newFile(),editFile:(i,o)=>this.editFile(i,o),isModified:()=>this.modified,setTheme:i=>this.setTheme(i),setVimMode:i=>this.setVimModeEnabled(i),setWrap:i=>this.setWrapEnabled(i),quit:()=>this.quit(),exportAs:i=>this.exportAs(i),getImageCount:()=>this.uploadedImages.size,importFromUrl:i=>this.importFromUrl(i),importFromClipboard:()=>this.importFromClipboard(),openImportDialog:()=>this.openImportDialog()},n=await Ke(e,t);n.message&&this.showStatus(n.message,!n.success)}async openFileDialog(){if(q()){let e=await fe();e&&(this.elements.editor.value=e.content,this.currentFileName=e.name,this.elements.fileName.textContent=e.name,this.currentFileHandle=e.handle,this.modified=!1,this.updateFileStatus(),this.updateLineNumbers(),this.updatePreview(),this.updateToc(),this.showStatus(`${e.name} - ${this.t.opened}`))}else this.elements.fileInput.click()}async handleFileOpen(e){let t=e.target,n=t.files?.[0];if(!n)return;if(n.name.endsWith(".mdvim")){await this.loadMdvimFile(n),t.value="";return}let i=new FileReader;i.onload=o=>{let r=M(o.target?.result);this.uploadedImages.clear(),this.elements.editor.value=r,this.currentFileName=n.name,this.elements.fileName.textContent=n.name,this.modified=!1,this.updateFileStatus(),this.updateLineNumbers(),this.updatePreview(),this.updateToc(),this.showStatus(`${n.name} - ${this.t.opened}`)},i.readAsText(n),t.value=""}async loadMdvimFile(e){try{let t=await JSZip.loadAsync(e),n="content.md",i=t.file("manifest.json");if(i)try{let r=await i.async("string"),a=JSON.parse(r);a.metadata?this.documentMetadata={title:a.metadata.title||"",author:a.metadata.author||"",language:a.metadata.language||"ja"}:this.documentMetadata={title:e.name.replace(/\.mdvim$/i,""),author:"",language:"ja"},a.content&&(n=a.content)}catch(r){console.warn("Failed to parse manifest.json:",r)}let o=t.file(n);if(o){let r=await o.async("string");this.elements.editor.value=M(r)}this.uploadedImages.clear();for(let[r,a]of Object.entries(t.files))if(r.startsWith("images/")&&!a.dir){let l=r.replace("images/",""),c=await a.async("base64"),d=l.split(".").pop()?.toLowerCase()||"png",m={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml",bmp:"image/bmp"}[d]||"image/png";this.uploadedImages.set(l,`data:${m};base64,${c}`)}this.currentFileName=e.name,this.elements.fileName.textContent=e.name,this.currentFileHandle=null,this.modified=!1,this.updateFileStatus(),this.updateLineNumbers(),this.updatePreview(),this.updateToc(),this.showStatus(`${e.name} - ${this.t.opened} (${this.uploadedImages.size} images)`)}catch(t){this.showStatus("Failed to load .mdvim file",!0),console.error(t)}}async saveCurrentFile(){let e=this.elements.editor.value;if(this.uploadedImages.size>0){await this.saveMdvimFile();return}let t=this.currentFileName.replace(/\.(md|mdvim)$/i,"")+".md";(t===".md"||t==="\u7121\u984C.md"||t==="Untitled.md")&&(t="document.md");let n=await ve(e,t,this.currentFileHandle);n&&(this.currentFileHandle=n,this.currentFileName=n.name,this.elements.fileName.textContent=n.name),this.modified=!1,this.updateFileStatus(),this.showStatus(this.t.saved)}async saveMdvimFile(){try{let e=new JSZip,t=this.currentFileName.replace(/\.(md|mdvim)$/i,"");(!t||t==="\u7121\u984C"||t==="Untitled")&&(t="document");let n=this.documentMetadata.title||t,i=[];this.uploadedImages.forEach((d,h)=>{i.push(h)});let o={version:"0.8.4",app:"mdvim",created:new Date().toISOString(),metadata:{title:n,author:this.documentMetadata.author,language:this.documentMetadata.language||this.currentLanguage},content:"content.md",images:i};e.file("manifest.json",JSON.stringify(o,null,2)),e.file("content.md",this.elements.editor.value);let r=e.folder("images");this.uploadedImages.forEach((d,h)=>{let m=d.split(",")[1];r.file(h,m,{base64:!0})});let a=await e.generateAsync({type:"blob",compression:"DEFLATE"}),l=URL.createObjectURL(a),c=document.createElement("a");c.href=l,c.download=`${t}.mdvim`,c.click(),URL.revokeObjectURL(l),this.currentFileName=`${t}.mdvim`,this.elements.fileName.textContent=this.currentFileName,this.modified=!1,this.updateFileStatus(),this.showStatus(`${this.t.saved} (${this.uploadedImages.size} images)`)}catch(e){this.showStatus("Failed to save .mdvim file",!0),console.error(e)}}async exportAs(e){switch(e){case"md":await this.exportMarkdownZip();break;case"html":await this.exportHtml();break;default:this.showStatus(`Unknown format: ${e}. Use md or html`,!0)}}async exportMarkdownZip(){try{let e=this.currentFileName.replace(/\.(md|mdvim)$/i,"");if((!e||e==="\u7121\u984C"||e==="Untitled")&&(e="document"),this.uploadedImages.size===0){let c=new Blob([this.elements.editor.value],{type:"text/markdown"}),d=URL.createObjectURL(c),h=document.createElement("a");h.href=d,h.download=`${e}.md`,h.click(),URL.revokeObjectURL(d),this.showStatus(`Exported: ${e}.md`);return}let t=new JSZip,n=[];this.uploadedImages.forEach((c,d)=>{n.push(d)});let i={version:"0.8.4",app:"mdvim",created:new Date().toISOString(),metadata:{title:this.documentMetadata.title||e,author:this.documentMetadata.author,language:this.documentMetadata.language||this.currentLanguage},content:"content.md",images:n};t.file("manifest.json",JSON.stringify(i,null,2)),t.file("content.md",this.elements.editor.value);let o=t.folder("images");this.uploadedImages.forEach((c,d)=>{let h=c.split(",")[1];o.file(d,h,{base64:!0})});let r=await t.generateAsync({type:"blob",compression:"DEFLATE"}),a=URL.createObjectURL(r),l=document.createElement("a");l.href=a,l.download=`${e}.mdvim`,l.click(),URL.revokeObjectURL(a),this.showStatus(`Exported: ${e}.mdvim (${this.uploadedImages.size} images)`)}catch(e){this.showStatus("Export failed",!0),console.error(e)}}async exportHtml(){try{let t=B.parse(this.elements.editor.value).html;t=this.replaceImagePaths(t);let n=`<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${this.currentFileName}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; line-height: 1.6; }
    pre { background: #282c34; padding: 1rem; border-radius: 6px; overflow-x: auto; }
    code { font-family: 'Fira Code', Consolas, monospace; }
    img { max-width: 100%; height: auto; }
    blockquote { border-left: 4px solid #7aa2f7; padding-left: 1rem; margin-left: 0; color: #666; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f5f5f5; }
  </style>
</head>
<body>
${t}
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"><\/script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"><\/script>
  <script>hljs.highlightAll();<\/script>
</body>
</html>`,i=new Blob([n],{type:"text/html"}),o=URL.createObjectURL(i),r=document.createElement("a");r.href=o;let a=this.currentFileName.replace(/\.(md|mdvim)$/i,"");(!a||a==="\u7121\u984C"||a==="Untitled")&&(a="document"),r.download=`${a}.html`,r.click(),URL.revokeObjectURL(o),this.showStatus(`Exported: ${a}.html`)}catch(e){this.showStatus("Export failed",!0),console.error(e)}}newFile(){this.modified&&!confirm("\u5909\u66F4\u3092\u7834\u68C4\u3057\u307E\u3059\u304B\uFF1F")||(this.elements.editor.value="",this.currentFileName="\u7121\u984C",this.elements.fileName.textContent="\u7121\u984C",this.currentFileHandle=null,this.uploadedImages.clear(),this.documentMetadata={title:"",author:"",language:"ja"},this.modified=!1,this.undoStack=[],this.redoStack=[],this.updateFileStatus(),this.updateLineNumbers(),this.updatePreview(),this.updateToc(),this.showStatus(this.t.newFile))}editFile(e,t){if(this.modified&&!t){this.showStatus("No write since last change (add ! to override)",!0);return}let n=e.trim();!n.endsWith(".md")&&!n.endsWith(".mdvim")&&(n+=".md"),this.elements.editor.value="",this.currentFileName=n,this.elements.fileName.textContent=n,this.currentFileHandle=null,this.uploadedImages.clear(),this.documentMetadata={title:n.replace(/\.(md|mdvim)$/i,""),author:"",language:"ja"},this.modified=!1,this.undoStack=[],this.redoStack=[],this.updateFileStatus(),this.updateLineNumbers(),this.updatePreview(),this.updateToc(),this.showStatus(`"${n}" [New File]`)}quit(){this.modified&&!confirm("\u5909\u66F4\u3092\u4FDD\u5B58\u305B\u305A\u306B\u7D42\u4E86\u3057\u307E\u3059\u304B\uFF1F")||window.close()}startMacroRecording(e){this.recordingMacro=e,this.macroBuffer=[],this.elements.macroIndicator.classList.add("active"),this.elements.modeIndicator.classList.add("recording"),this.showStatus(`${this.t.macroRecording}${e}`)}stopMacroRecording(){this.recordingMacro&&(this.macros[this.recordingMacro]=[...this.macroBuffer],this.showStatus(`${this.t.macroSaved}${this.recordingMacro}`),this.recordingMacro=null,this.macroBuffer=[],this.elements.macroIndicator.classList.remove("active"),this.elements.modeIndicator.classList.remove("recording"))}playMacro(e){let t=this.macros[e];if(t)for(let n of t){let i=new KeyboardEvent("keydown",{key:n.key,ctrlKey:n.ctrlKey,shiftKey:n.shiftKey,bubbles:!0});this.handleKeydown(i)}}onInput(){this.modified=!0,this.updateFileStatus(),this.updateLineNumbers(),this.updatePreview(),this.updateCursorPos()}updateLineNumbers(){let e=this.elements.editor,t=e.value.split(`
`),n=[];if(this.wrapEnabled){let i=this.getLineHeight(),o=e.clientWidth-16,r=document.createElement("div");r.style.cssText=`
        position: absolute;
        visibility: hidden;
        white-space: pre-wrap;
        overflow-wrap: break-word;
        font-family: ${getComputedStyle(e).fontFamily};
        font-size: ${getComputedStyle(e).fontSize};
        line-height: ${getComputedStyle(e).lineHeight};
        width: ${o}px;
        padding: 0;
        margin: 0;
        border: none;
      `,document.body.appendChild(r);for(let a=0;a<t.length;a++){let l=t[a],c="line-num",d=l.match(/^(#{1,6})\s/);d&&(c+=` heading-h${d[1].length}`),r.textContent=l||" ";let h=r.offsetHeight,p=Math.max(1,Math.round(h/i))*i;n.push(`<span class="${c}" style="height: ${p}px;">${a+1}</span>`)}document.body.removeChild(r)}else for(let i=0;i<t.length;i++){let o=t[i],r="line-num",a=o.match(/^(#{1,6})\s/);a&&(r+=` heading-h${a[1].length}`),n.push(`<span class="${r}">${i+1}</span>`)}this.elements.lineNumbers.innerHTML=n.join("")}getLineHeight(){let e=this.elements.editor,t=getComputedStyle(e),n=t.lineHeight;return n==="normal"?parseFloat(t.fontSize)*1.2:parseFloat(n)}updatePreview(){let t=B.parse(this.elements.editor.value).html;t=this.replaceImagePaths(t),this.elements.preview.innerHTML=t,this.elements.preview.querySelectorAll("pre code").forEach(n=>{typeof hljs<"u"&&hljs.highlightElement(n)}),this.renderMath(),this.renderMermaid(),this.setupHeadingFold()}replaceImagePaths(e){return e.replace(/src="images\/([^"]+)"/g,(t,n)=>{let i=this.uploadedImages.get(n);return i?`src="${i}"`:t})}setupHeadingFold(){this.elements.preview.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(t=>{if(!t.querySelector(".fold-indicator")){let n=document.createElement("span");n.className="fold-indicator",n.textContent="\u25BC",t.insertBefore(n,t.firstChild)}t.onclick=()=>{this.toggleHeadingFold(t)}})}toggleHeadingFold(e){let t=parseInt(e.tagName[1]),n=e.querySelector(".fold-indicator");if(e.classList.contains("folded")){e.classList.remove("folded"),n&&(n.textContent="\u25BC");let o=e.nextElementSibling,r=null;for(;o;){if(/^H[1-6]$/.test(o.tagName)){let a=parseInt(o.tagName[1]);if(a<=t)break;r===null&&(r=a),a===r&&(o.style.display="",o.classList.remove("heading-hidden"))}else r===null&&(o.style.display="",o.classList.remove("heading-hidden"));o=o.nextElementSibling}}else{e.classList.add("folded"),n&&(n.textContent="\u25B6");let o=e.nextElementSibling;for(;o;){if(/^H[1-6]$/.test(o.tagName)){if(parseInt(o.tagName[1])<=t)break;o.classList.add("folded");let a=o.querySelector(".fold-indicator");a&&(a.textContent="\u25B6")}o.style.display="none",o.classList.add("heading-hidden"),o=o.nextElementSibling}}}renderMath(){typeof katex>"u"||(this.elements.preview.querySelectorAll(".math-inline").forEach(e=>{let t=e.getAttribute("data-math");if(t)try{katex.render(t,e,{throwOnError:!1})}catch{e.textContent=t}}),this.elements.preview.querySelectorAll(".math-block").forEach(e=>{let t=e.getAttribute("data-math");if(t)try{katex.render(t,e,{throwOnError:!1,displayMode:!0})}catch{e.textContent=t}}))}renderMermaid(){typeof mermaid>"u"||mermaid.init(void 0,this.elements.preview.querySelectorAll(".mermaid"))}updateToc(){let e=B.parse(this.elements.editor.value),t=B.generateTocHtml(e.toc);this.elements.tocContent.innerHTML=t,this.elements.tocContent.querySelectorAll(".toc-entry").forEach(n=>{n.addEventListener("click",i=>{i.preventDefault();let o=parseInt(n.getAttribute("data-line")||"0");this.gotoLine(o+1),this.elements.editor.focus()})})}toggleToc(){let e=this.elements.tocPane,t=this.elements.tocOpenBtn;e.classList.contains("hidden")?(e.classList.remove("hidden"),t.classList.add("hidden")):(e.classList.add("hidden"),t.classList.remove("hidden"))}updateCursorPos(){let e=We(this.elements.editor);this.elements.cursorPos.textContent=`${e.line}:${e.column}`}updateCursorOverlay(){this.cursorUpdateScheduled||(this.cursorUpdateScheduled=!0,requestAnimationFrame(()=>{this.cursorUpdateScheduled=!1,this.renderCursorOverlay()}))}renderCursorOverlay(){let e=this.elements.editor,t=this.elements.cursorOverlay;if(!this.vimMode){t.style.display="none",e.style.caretColor="var(--accent)";return}e.style.caretColor="transparent";let n=e.value,i=e.selectionStart,o=getComputedStyle(e),r=parseFloat(o.paddingTop)||0,a=parseFloat(o.paddingLeft)||0,l=parseFloat(o.fontSize)||16,c=parseFloat(o.lineHeight);isNaN(c)&&(c=l*1.5);let d=l*.6;this.measureSpan&&(this.measureSpan.style.fontFamily=o.fontFamily,this.measureSpan.style.fontSize=o.fontSize,this.measureSpan.style.fontWeight=o.fontWeight,this.measureSpan.style.letterSpacing=o.letterSpacing,this.measureSpan.style.lineHeight=o.lineHeight,this.measureSpan.textContent="M",d=this.measureSpan.getBoundingClientRect().width);let h,m;if(this.wrapEnabled){let p=this.measureCursorPosition(i);h=r+p.top-e.scrollTop,m=a+p.left-e.scrollLeft}else{let g=n.substring(0,i).split(`
`),u=g.length-1,v=g[u],w=0;this.measureSpan&&v.length>0&&(this.measureSpan.textContent=v,w=this.measureSpan.getBoundingClientRect().width),h=r+u*c-e.scrollTop,m=a+w-e.scrollLeft}t.style.top=`${h}px`,t.style.left=`${m}px`,t.style.width=`${d}px`,t.style.height=`${c}px`,t.className=this.mode,h<-c||h>e.clientHeight?t.style.display="none":t.style.display="block"}measureCursorPosition(e){let t=this.elements.editor,n=t.value,i=getComputedStyle(t),o=parseFloat(i.paddingLeft)||0,r=parseFloat(i.paddingRight)||0,a=t.clientWidth-o-r,l=document.createElement("pre");l.style.cssText=`
      position: absolute;
      visibility: hidden;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      word-break: break-word;
      font-family: ${i.fontFamily};
      font-size: ${i.fontSize};
      font-weight: ${i.fontWeight};
      letter-spacing: ${i.letterSpacing};
      line-height: ${i.lineHeight};
      tab-size: ${i.tabSize||"4"};
      padding: 0;
      margin: 0;
      border: none;
      width: ${a}px;
      box-sizing: border-box;
    `;let c=n.substring(0,e),d=n[e]||"X",h=document.createTextNode(c),m=document.createElement("span");m.id="cursor-marker",m.textContent=d===`
`?" ":d,l.appendChild(h),l.appendChild(m),document.body.appendChild(l);let p=l.getBoundingClientRect(),g=m.getBoundingClientRect(),u={top:g.top-p.top,left:g.left-p.left};return document.body.removeChild(l),u}moveDisplayLine(e,t=1){let n=this.elements.editor,i=n.value;for(let o=0;o<t;o++){let r=n.selectionStart,a=this.measureCursorPosition(r),l=a.left,c=a.top;if(e>0){let d=r;for(let g=r+1;g<=i.length;g++){if(this.measureCursorPosition(g).top>c+2){d=g;break}if(i[g-1]===`
`){d=g;break}}if(d===r)return;let h=this.measureCursorPosition(d).top,m=d,p=Math.abs(this.measureCursorPosition(d).left-l);for(let g=d;g<=i.length;g++){let u=this.measureCursorPosition(g);if(u.top>h+2||i[g-1]===`
`)break;let v=Math.abs(u.left-l);v<p&&(p=v,m=g)}n.selectionStart=m,n.selectionEnd=m}else{let d=r;for(let u=r-1;u>=0;u--){if(this.measureCursorPosition(u).top<c-2){d=u;break}if(i[u]===`
`){d=u;break}}if(d===r)return;let h=this.measureCursorPosition(d).top,m=d;for(let u=d-1;u>=0&&!(this.measureCursorPosition(u).top<h-2);u--){if(i[u]===`
`){m=u+1;break}m=u}let p=m,g=Math.abs(this.measureCursorPosition(m).left-l);for(let u=m;u<=d;u++){let v=this.measureCursorPosition(u);if(v.top>h+2)break;let w=Math.abs(v.left-l);w<g&&(g=w,p=u)}n.selectionStart=p,n.selectionEnd=p}}}measureCharWidth(){return this.measureSpan?(this.measureSpan.textContent="M",this.measureSpan.getBoundingClientRect().width):8}syncScrollToPreview(){if(this.isScrollSyncing)return;this.isScrollSyncing=!0;let e=this.elements.editor,t=this.elements.preview,n=e.scrollHeight-e.clientHeight;if(n>0){let i=e.scrollTop/n,o=t.scrollHeight-t.clientHeight;t.scrollTop=i*o}requestAnimationFrame(()=>{this.isScrollSyncing=!1})}syncScrollToEditor(){if(this.isScrollSyncing)return;this.isScrollSyncing=!0;let e=this.elements.editor,t=this.elements.preview,n=t.scrollHeight-t.clientHeight;if(n>0){let i=t.scrollTop/n,o=e.scrollHeight-e.clientHeight;e.scrollTop=i*o,this.elements.lineNumbers.scrollTop=e.scrollTop,this.updateCursorOverlay()}requestAnimationFrame(()=>{this.isScrollSyncing=!1})}syncScroll(){this.syncScrollToPreview()}updateFileStatus(){this.elements.fileStatus.textContent=this.modified?"[\u5909\u66F4\u3042\u308A]":""}gotoLine(e){Te(this.elements.editor,e),this.updateCursorPos(),this.updateCursorOverlay()}setTheme(e){document.body.setAttribute("data-theme",e),F.saveSettings({theme:e}),document.querySelectorAll('[id^="btn-theme-"]').forEach(t=>{t.classList.remove("active")}),document.getElementById(`btn-theme-${e}`)?.classList.add("active")}setLanguage(e){this.currentLanguage=e,this.t=ce[e],localStorage.setItem("mdvim-language",e),this.updateUIText(),this.updateHelpModal();let t=document.getElementById("language-selector");t&&(t.value=e)}getLanguage(){return this.currentLanguage}updateUIText(){let e=this.t,t=document.getElementById("btn-edit"),n=document.getElementById("btn-preview"),i=document.getElementById("btn-split");t&&(t.textContent=e.edit),n&&(n.textContent=e.preview),i&&(i.textContent=e.split);let o=document.querySelector('[onclick*="decreaseFontSize"]'),r=document.querySelector('[onclick*="increaseFontSize"]');o&&o.setAttribute("title",e.fontSmaller),r&&r.setAttribute("title",e.fontLarger);let a=document.querySelector("#toc-header span"),l=document.getElementById("toc-toggle"),c=document.getElementById("toc-open-btn");a&&(a.textContent=e.toc),l&&l.setAttribute("title",e.closeToc),c&&c.setAttribute("title",e.openToc);let d=document.querySelector('[onclick*="foldAllHeadings"]'),h=document.querySelector('[onclick*="unfoldAllHeadings"]');d&&(d.textContent=e.foldAll),h&&(h.textContent=e.unfoldAll);let m=document.getElementById("btn-vim-mode");m&&m.setAttribute("title",e.vimModeToggle),this.currentFileName||(this.elements.fileName.textContent=e.untitled);let p=document.getElementById("help-hint");p&&(p.textContent=e.helpHint);let g=document.querySelector("#help-modal button");g&&(g.textContent=e.helpClose),document.title=`mdvim v0.8.4 - ${e.appTitle.split(" - ")[1]||e.appTitle}`;let u=document.getElementById("language-selector");u&&(u.value=this.currentLanguage)}updateHelpModal(){let e=this.t,t=document.getElementById("help-modal");if(!t)return;let n=t.querySelector("h2");n&&(n.textContent=e.helpTitle);let i=t.querySelectorAll(".help-section"),o=[e.helpModeSwitch,e.helpMovement,e.helpEditing,e.helpTextObjects,e.helpSearchReplace,e.helpMarkdown];i.forEach((r,a)=>{let l=r.querySelector("h3");l&&o[a]&&(l.textContent=o[a])})}increaseFontSize(){this.fontSize=Math.min(200,this.fontSize+10),this.applyFontSize(),F.saveSettings({fontSize:this.fontSize})}decreaseFontSize(){this.fontSize=Math.max(50,this.fontSize-10),this.applyFontSize(),F.saveSettings({fontSize:this.fontSize})}applyFontSize(){let e=this.fontSize/100;this.elements.editor.style.fontSize=`${.95*e}rem`,this.elements.lineNumbers.style.fontSize=`${.95*e}rem`,this.elements.preview.style.fontSize=`${1*e}rem`,this.elements.fontSizeDisplay.textContent=`${this.fontSize}%`,this.wrapEnabled&&requestAnimationFrame(()=>this.updateLineNumbers())}toggleVimMode(){this.vimMode=!this.vimMode,this.updateVimModeButton(),F.saveSettings({vimMode:this.vimMode}),this.vimMode?(this.enterNormalMode(),this.showStatus("VIM\u30E2\u30FC\u30C9 ON (Ctrl+Shift+V \u307E\u305F\u306F F2 \u3067\u5207\u66FF)")):(this.mode="insert",this.elements.modeIndicator.textContent="EDIT",this.elements.modeIndicator.className="edit-mode",this.elements.editor.classList.add("insert-mode"),this.showStatus("VIM\u30E2\u30FC\u30C9 OFF (Ctrl+Shift+V \u307E\u305F\u306F F2 \u3067\u5207\u66FF)"))}setVimModeEnabled(e){this.vimMode!==e&&this.toggleVimMode()}setWrapEnabled(e){this.wrapEnabled=e;let t=this.elements.editor,n=this.elements.lineNumbers;e?(t.style.whiteSpace="pre-wrap",t.style.overflowWrap="break-word",n.classList.add("wrap-mode")):(t.style.whiteSpace="pre",t.style.overflowWrap="normal",n.classList.remove("wrap-mode")),this.updateLineNumbers()}updateVimModeButton(){let e=document.getElementById("btn-vim-mode");e&&(e.textContent=this.vimMode?"VIM":"NOVIM",e.classList.toggle("active",this.vimMode))}toggleHelp(){let e=document.getElementById("help-modal");e&&e.classList.toggle("hidden")}foldAllHeadings(){this.elements.preview.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(e=>{e.classList.add("folded"),this.foldHeadingContent(e)})}unfoldAllHeadings(){this.elements.preview.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(e=>{e.classList.remove("folded")}),this.elements.preview.querySelectorAll(".heading-hidden").forEach(e=>{e.classList.remove("heading-hidden")})}foldHeadingContent(e){let t=parseInt(e.tagName.substring(1)),n=e.nextElementSibling;for(;n&&!(/^H[1-6]$/.test(n.tagName)&&parseInt(n.tagName.substring(1))<=t);)n.classList.add("heading-hidden"),n=n.nextElementSibling}};var $t="0.8.4";return At(Bt);})();

</script>

  <script>
    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
    let vimEditor;

    // „Éì„É•„Éº„É¢„Éº„ÉâË®≠ÂÆö
    function setViewMode(mode) {
      const container = document.getElementById('main-container');
      const editorPane = document.getElementById('editor-pane');
      const previewPane = document.getElementById('preview-pane');
      
      container.className = mode + '-view';
      
      document.querySelectorAll('.view-controls button').forEach(btn => {
        if (btn.id.startsWith('btn-')) {
          btn.classList.remove('active');
        }
      });
      document.getElementById('btn-' + mode)?.classList.add('active');
      
      if (mode === 'edit') {
        editorPane.style.display = 'flex';
        previewPane.style.display = 'none';
      } else if (mode === 'preview') {
        editorPane.style.display = 'none';
        previewPane.style.display = 'flex';
      } else {
        editorPane.style.display = 'flex';
        previewPane.style.display = 'flex';
      }
    }

    // „ÉÜ„Éº„ÉûË®≠ÂÆö
    function setTheme(theme) {
      if (vimEditor) {
        vimEditor.setTheme(theme);
      } else {
        document.body.setAttribute('data-theme', theme);
      }
    }

    // „Éò„É´„Éó„Éà„Ç∞„É´
    function toggleHelp() {
      const modal = document.getElementById('help-modal');
      modal.classList.toggle('hidden');
    }

    // ÂàùÊúüÂåñ
    document.addEventListener('DOMContentLoaded', () => {
      // VimEditor„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàê
      if (typeof mdvim !== 'undefined' && mdvim.VimEditor) {
        vimEditor = new mdvim.VimEditor();
      }
    });
  </script>
</body>
</html>
